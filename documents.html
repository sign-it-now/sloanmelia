<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light">
    <title>Document Vault - SloanMelia</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Georgia', serif;
            background-color: #f5f5f0;
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: #1a1a1a;
            color: white;
            padding: 30px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo { text-align: center; margin-bottom: 10px; }

        .logo-box {
            background-color: #d4a574;
            color: #1a1a1a;
            width: 50px;
            height: 50px;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .brand-name { font-style: italic; font-size: 1.3em; margin-bottom: 5px; }
        .tagline { font-size: 0.7em; letter-spacing: 2px; color: #888; }

        .nav-menu { margin-top: 40px; }

        .nav-item {
            padding: 15px 30px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: white;
            font-size: 0.85em;
            letter-spacing: 1px;
        }

        .nav-item:hover { background-color: #2a2a2a; }

        .nav-item.active {
            background-color: rgba(212,165,116,0.15);
            border-left: 3px solid #d4a574;
            color: #f0d090;
        }

        .main-content { margin-left: 250px; flex: 1; padding: 50px; }

        .page-header { margin-bottom: 32px; }
        .page-header h1 { font-size: 2.2em; color: #333; margin-bottom: 10px; }
        .page-header h1 .highlight { font-style: italic; color: #d4a574; }
        .page-subtitle { font-size: 0.82em; color: #888; letter-spacing: 2px; text-transform: uppercase; }

        .vault-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .vault-card {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 24px;
        }

        .vault-card-icon { font-size: 2em; margin-bottom: 12px; }
        .vault-card-title { font-size: 1.05em; font-weight: 600; color: #333; margin-bottom: 8px; }
        .vault-card-desc { font-size: 0.85em; color: #666; line-height: 1.6; margin-bottom: 16px; }
        .vault-card-count { font-size: 0.72em; letter-spacing: 1.5px; text-transform: uppercase; color: #d4a574; }

        .loading-msg { font-size: 0.88em; color: #888; font-style: italic; }

        .doc-list { display: flex; flex-direction: column; gap: 10px; margin-top: 16px; }

        .doc-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #fafaf8;
            border: 1px solid #e8e0d0;
            font-size: 0.88em;
        }

        .doc-name { font-weight: 500; color: #333; }

        .doc-badge {
            font-size: 0.68em;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            padding: 3px 10px;
            background: rgba(212,165,116,0.15);
            color: #a07030;
            border: 1px solid rgba(212,165,116,0.3);
        }

        .doc-date { font-size: 0.75em; color: #888; }

        .upload-section {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 28px;
            margin-top: 32px;
        }

        .section-label {
            font-size: 0.72em;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #d4a574;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-label::before { content: ''; display: block; width: 20px; height: 1px; background: #d4a574; }

        .upload-row { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }

        .field-wrap { display: flex; flex-direction: column; gap: 6px; }

        .field-label { font-size: 0.72em; letter-spacing: 1.5px; text-transform: uppercase; color: #888; }

        select.cat-select, input.file-input-styled {
            padding: 10px 14px;
            border: 1px solid #e0e0e0;
            font-family: 'Georgia', serif;
            font-size: 0.88em;
            background: #fafaf8;
            outline: none;
            color: #333;
            min-width: 180px;
        }

        select.cat-select:focus, input.file-input-styled:focus { border-color: #d4a574; }

        .upload-btn {
            background: #d4a574;
            color: #1a1a1a;
            border: none;
            padding: 10px 22px;
            cursor: pointer;
            font-size: 0.72em;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            font-family: 'Georgia', serif;
            transition: background 0.2s;
        }

        .upload-btn:hover { background: #c09050; }
        .upload-btn:disabled { background: #ccc; cursor: default; }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 12px 20px;
            font-size: 0.82em;
            letter-spacing: 1px;
            z-index: 999;
            animation: fadeIn 0.2s;
        }

        .toast-success { background: #1a6a2a; color: white; }
        .toast-error { background: #9a1a1a; color: white; }
        .toast-warn { background: #d4a574; color: #1a1a1a; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .empty-state { text-align: center; padding: 40px; color: #aaa; font-style: italic; font-size: 0.9em; }

        @media(max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; padding: 24px 18px; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo">
        <div class="logo-box">SM</div>
        <div class="brand-name">SloanMelia</div>
        <div class="tagline">COLLEGE COMMAND CENTER</div>
    </div>
    <div class="nav-menu">
        <a href="dashboard.html" class="nav-item"><span>üè†</span> HOME</a>
        <a href="study-library.html" class="nav-item"><span>üìö</span> STUDY LIBRARY</a>
        <a href="documents.html" class="nav-item active"><span>üìÑ</span> DOCUMENT VAULT</a>
        <a href="dashboard.html#colleges" class="nav-item"><span>üéì</span> COLLEGE TRACKER</a>
        <a href="dashboard.html#achievements" class="nav-item"><span>‚≠ê</span> ACHIEVEMENTS</a>
        <a href="financial-aid.html" class="nav-item"><span>üí∞</span> FINANCIAL AID</a>
        <a href="coach.html" class="nav-item"><span>ü§ñ</span> COACH</a>
    </div>
</div>

<div class="main-content">
    <div class="page-header">
        <h1>Document <span class="highlight">Vault</span></h1>
        <p class="page-subtitle">Secure File Storage ¬∑ Transcripts ¬∑ Letters ¬∑ Certificates</p>
    </div>

    <!-- Stats -->
    <div class="vault-grid">
        <div class="vault-card">
            <div class="vault-card-icon">üìÑ</div>
            <div class="vault-card-title">Total Documents</div>
            <div class="vault-card-desc">All uploaded files across every category.</div>
            <div class="vault-card-count" id="totalCount">Loading...</div>
        </div>
        <div class="vault-card">
            <div class="vault-card-icon">üéì</div>
            <div class="vault-card-title">Transcripts &amp; Scores</div>
            <div class="vault-card-desc">Academic records and standardized test scores.</div>
            <div class="vault-card-count" id="transcriptCount">Loading...</div>
        </div>
        <div class="vault-card">
            <div class="vault-card-icon">‚úâÔ∏è</div>
            <div class="vault-card-title">Recommendation Letters</div>
            <div class="vault-card-desc">Teacher and counselor recommendation letters.</div>
            <div class="vault-card-count" id="recLetterCount">Loading...</div>
        </div>
    </div>

    <!-- Upload -->
    <div class="upload-section">
        <div class="section-label">Upload Document</div>
        <div class="upload-row">
            <div class="field-wrap">
                <span class="field-label">Category</span>
                <select class="cat-select" id="catSelect">
                    <option>Transcript</option>
                    <option>Recommendation Letter</option>
                    <option>Resume</option>
                    <option>Test Scores</option>
                    <option>Certificate</option>
                    <option>Financial Aid</option>
                    <option>Other</option>
                </select>
            </div>
            <div class="field-wrap">
                <span class="field-label">File (max 10MB)</span>
                <input type="file" id="fileInput" class="file-input-styled" accept=".pdf,.doc,.docx,.txt,.png,.jpg">
            </div>
            <button class="upload-btn" id="uploadBtn" onclick="uploadDoc()">‚¨Ü Upload</button>
        </div>
    </div>

    <!-- Document list -->
    <div class="upload-section" style="margin-top:20px;">
        <div class="section-label">Your Documents</div>
        <div id="docList"><div class="loading-msg">Loading documents...</div></div>
    </div>
</div>

<script>
const SUPABASE_URL = 'https://gpktuflimoqeyxtwadsy.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdwa3R1ZmxpbW9xZXl4dHdhZHN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2ODM2MDEsImV4cCI6MjA4NzI1OTYwMX0.q3RMeKEo17qXgt-a9ljtMfKJ46etHy4_rrj1cs64A4U';

const sbUrl = localStorage.getItem('sm_url') || SUPABASE_URL;
const sbKey = localStorage.getItem('sm_key') || SUPABASE_KEY;
const sb = window.supabase.createClient(sbUrl, sbKey);

let currentUser = null;
let allDocs = [];

async function init() {
    const { data: { session } } = await sb.auth.getSession();
    if (!session?.user) {
        document.getElementById('docList').innerHTML = '<div class="empty-state">Sign in via <a href="app.html" style="color:#d4a574">app.html</a> to view your documents.</div>';
        ['totalCount','transcriptCount','recLetterCount'].forEach(id => document.getElementById(id).textContent = '‚Äî');
        return;
    }
    currentUser = session.user;
    loadDocs();
}

async function loadDocs() {
    const { data, error } = await sb.from('documents').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
    if (error) {
        document.getElementById('docList').innerHTML = `<div class="empty-state">Error loading documents: ${error.message}</div>`;
        return;
    }
    allDocs = data || [];
    renderDocs();
    renderStats();
}

function renderStats() {
    document.getElementById('totalCount').textContent = allDocs.length + ' file' + (allDocs.length !== 1 ? 's' : '');
    const transcripts = allDocs.filter(d => d.category === 'Transcript' || d.category === 'Test Scores').length;
    const letters = allDocs.filter(d => d.category === 'Recommendation Letter').length;
    document.getElementById('transcriptCount').textContent = transcripts + ' file' + (transcripts !== 1 ? 's' : '');
    document.getElementById('recLetterCount').textContent = letters + ' file' + (letters !== 1 ? 's' : '');
}

function renderDocs() {
    const container = document.getElementById('docList');
    if (!allDocs.length) {
        container.innerHTML = '<div class="empty-state">No documents uploaded yet. Use the form above to add your first file.</div>';
        return;
    }
    container.innerHTML = '';
    const list = document.createElement('div');
    list.className = 'doc-list';
    allDocs.forEach(doc => {
        const row = document.createElement('div');
        row.className = 'doc-row';
        const date = new Date(doc.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const size = doc.file_size ? (doc.file_size / 1024 < 1000 ? Math.round(doc.file_size / 1024) + ' KB' : (doc.file_size / 1024 / 1024).toFixed(1) + ' MB') : '';
        row.innerHTML = `
            <div>
                <div class="doc-name">${doc.name}</div>
                <div class="doc-date">${date}${size ? ' ¬∑ ' + size : ''}</div>
            </div>
            <div style="display:flex;align-items:center;gap:10px;">
                <span class="doc-badge">${doc.category}</span>
                <button onclick="deleteDoc('${doc.id}', '${doc.file_path}', this)" style="background:none;border:none;cursor:pointer;color:#9a1a1a;font-size:0.8em;padding:4px 8px;letter-spacing:1px;">‚úï</button>
            </div>
        `;
        list.appendChild(row);
    });
    container.appendChild(list);
}

async function uploadDoc() {
    const file = document.getElementById('fileInput').files[0];
    const cat = document.getElementById('catSelect').value;
    if (!file) { showToast('Select a file first.', 'warn'); return; }
    if (!currentUser) { showToast('Sign in first via app.html.', 'warn'); return; }
    if (file.size > 10 * 1024 * 1024) { showToast('File must be under 10MB.', 'error'); return; }

    const btn = document.getElementById('uploadBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Uploading...';

    const path = `${currentUser.id}/${Date.now()}_${file.name}`;
    const { error: se } = await sb.storage.from('documents').upload(path, file);
    if (se) { showToast('Upload failed: ' + se.message, 'error'); btn.disabled = false; btn.textContent = '‚¨Ü Upload'; return; }

    const { error: de } = await sb.from('documents').insert({ user_id: currentUser.id, name: file.name, category: cat, file_path: path, file_size: file.size });
    if (de) showToast('Saved to storage but DB record failed.', 'warn');
    else showToast('Document uploaded!', 'success');

    btn.disabled = false;
    btn.textContent = '‚¨Ü Upload';
    document.getElementById('fileInput').value = '';
    loadDocs();
}

async function deleteDoc(id, filePath, btn) {
    if (!confirm('Delete this document?')) return;
    btn.disabled = true;
    await sb.storage.from('documents').remove([filePath]);
    await sb.from('documents').delete().eq('id', id);
    showToast('Document deleted.', 'success');
    loadDocs();
}

function showToast(msg, type = 'success') {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    const t = document.createElement('div');
    t.className = `toast toast-${type}`;
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

init();
</script>
</body>
</html>

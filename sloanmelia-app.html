<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light">
<title>SloanMelia â€” Sloan Smith Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&family=DM+Mono:wght@300;400;500&family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<style>
:root {
  color-scheme: light only;
  --bg: #faf7f2;
  --ink: #0e0c09;
  --gold: #c8922a;
  --gold-light: #f0d090;
  --teal: #1a4a45;
  --cream: #f0ead8;
  --dim: #7a7060;
  --faint: #e5ddd0;
  --white: #ffffff;
  --green: #1a6a2a;
  --red: #9a1a1a;
  --blue: #1a3a7a;
  --purple: #5a1a9a;
  --sidebar-w: 240px;
}
@media (prefers-color-scheme: dark) { html,body { background:#faf7f2!important; color:#0e0c09!important; } }
*{margin:0;padding:0;box-sizing:border-box;}
html,body{background:#faf7f2!important;color:#0e0c09!important;font-family:'Jost',sans-serif;font-size:15px;line-height:1.6;min-height:100vh;}
#root{min-height:100vh;}

/* UTILS */
.mono{font-family:'DM Mono',monospace;}
.serif{font-family:'Playfair Display',serif;}
.gold{color:var(--gold);}
.dim{color:var(--dim);}
.flex{display:flex;}
.items-center{align-items:center;}
.gap1{gap:0.5rem;}
.gap2{gap:1rem;}
.gap3{gap:1.5rem;}
.w100{width:100%;}
.mt1{margin-top:0.5rem;}
.mt2{margin-top:1rem;}
.mt3{margin-top:1.5rem;}
.mb1{margin-bottom:0.5rem;}
.mb2{margin-bottom:1rem;}

/* BUTTONS */
.btn{font-family:'DM Mono',monospace;font-size:0.6rem;letter-spacing:0.15em;text-transform:uppercase;padding:0.65rem 1.4rem;border:none;cursor:pointer;transition:all 0.18s;display:inline-flex;align-items:center;gap:0.4rem;}
.btn-primary{background:var(--ink);color:var(--bg);}
.btn-primary:hover{background:var(--teal);}
.btn-gold{background:var(--gold);color:var(--ink);}
.btn-gold:hover{background:#a87020;}
.btn-outline{background:transparent;border:1px solid var(--ink);color:var(--ink);}
.btn-outline:hover{background:var(--ink);color:var(--bg);}
.btn-ghost{background:transparent;color:var(--dim);padding:0.4rem 0.8rem;font-size:0.58rem;}
.btn-ghost:hover{color:var(--ink);}
.btn-sm{padding:0.4rem 0.9rem;font-size:0.55rem;}
.btn-danger{background:#7a1a1a;color:#fff;}
.btn-danger:hover{background:#9a2a2a;}

/* INPUTS */
.input{width:100%;padding:0.65rem 0.9rem;border:1px solid var(--faint);background:var(--white);font-family:'Jost',sans-serif;font-size:0.88rem;color:var(--ink);outline:none;transition:border 0.18s;}
.input:focus{border-color:var(--gold);}
.input::placeholder{color:#b0a890;}
.label{font-family:'DM Mono',monospace;font-size:0.58rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--dim);display:block;margin-bottom:0.35rem;}
.select{width:100%;padding:0.65rem 0.9rem;border:1px solid var(--faint);background:var(--white);font-family:'Jost',sans-serif;font-size:0.88rem;color:var(--ink);outline:none;cursor:pointer;}
textarea.input{resize:vertical;min-height:80px;}

/* CARDS */
.card{background:var(--white);border:1px solid var(--faint);padding:1.2rem 1.4rem;}
.card-title{font-family:'Playfair Display',serif;font-size:1.05rem;font-weight:700;margin-bottom:0.3rem;}
.card-label{font-family:'DM Mono',monospace;font-size:0.55rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--gold);display:block;margin-bottom:0.2rem;}

/* BADGES */
.badge{font-family:'DM Mono',monospace;font-size:0.52rem;letter-spacing:0.1em;text-transform:uppercase;padding:0.2rem 0.6rem;display:inline-block;}
.badge-teal{background:#d0eae8;color:var(--teal);}
.badge-gold{background:#faecd0;color:#8a5a10;}
.badge-ink{background:#e8e0d8;color:var(--ink);}
.badge-green{background:#d0eaD0;color:var(--green);}
.badge-blue{background:#d0daea;color:var(--blue);}
.badge-purple{background:#e0d0ea;color:var(--purple);}
.badge-red{background:#ead0d0;color:var(--red);}
.badge-gray{background:#e8e0d8;color:var(--dim);}

/* TOASTS */
.toast-container{position:fixed;top:1rem;right:1rem;z-index:9999;display:flex;flex-direction:column;gap:0.5rem;}
.toast{padding:0.8rem 1.2rem;font-size:0.85rem;font-family:'DM Mono',monospace;font-size:0.62rem;letter-spacing:0.08em;animation:slideIn 0.2s ease;}
.toast-success{background:var(--green);color:#fff;}
.toast-error{background:var(--red);color:#fff;}
.toast-warn{background:var(--gold);color:var(--ink);}
@keyframes slideIn{from{transform:translateX(100%);opacity:0;}to{transform:translateX(0);opacity:1;}}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(14,12,9,0.7);z-index:1000;display:flex;align-items:center;justify-content:center;padding:1rem;}
.modal{background:var(--bg);max-width:600px;width:100%;max-height:90vh;overflow-y:auto;padding:2rem;}
.modal-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem;}
.modal-title{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;}
.modal-close{background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--dim);line-height:1;}

/* SIDEBAR */
.sidebar{width:var(--sidebar-w);background:var(--ink);color:#e0d8d0;display:flex;flex-direction:column;min-height:100vh;flex-shrink:0;position:fixed;top:0;left:0;bottom:0;z-index:100;}
.sidebar-logo{padding:1.5rem 1.2rem 1rem;border-bottom:1px solid rgba(255,255,255,0.08);}
.sidebar-logo .monogram{width:36px;height:36px;background:var(--gold);color:var(--ink);font-family:'Playfair Display',serif;font-weight:900;font-size:1rem;display:flex;align-items:center;justify-content:center;margin-bottom:0.5rem;}
.sidebar-logo .app-name{font-family:'Playfair Display',serif;font-size:1rem;font-style:italic;color:#fff;}
.sidebar-logo .app-sub{font-family:'DM Mono',monospace;font-size:0.52rem;letter-spacing:0.12em;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-top:0.1rem;}
.sidebar-nav{flex:1;padding:1rem 0;}
.nav-item{display:flex;align-items:center;gap:0.8rem;padding:0.7rem 1.2rem;cursor:pointer;font-size:0.88rem;color:rgba(255,255,255,0.55);transition:all 0.15s;border-left:3px solid transparent;}
.nav-item:hover{background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.9);}
.nav-item.active{background:rgba(200,146,42,0.12);color:#f0d090;border-left-color:var(--gold);}
.nav-item .nav-icon{font-size:1rem;width:20px;text-align:center;flex-shrink:0;}
.nav-item .nav-label{font-family:'DM Mono',monospace;font-size:0.6rem;letter-spacing:0.1em;text-transform:uppercase;}
.nav-item.coach-nav{background:rgba(200,146,42,0.08);}
.nav-item.coach-nav.active,.nav-item.coach-nav:hover{background:rgba(200,146,42,0.2);}
.sidebar-footer{padding:1rem 1.2rem;border-top:1px solid rgba(255,255,255,0.08);}
.sidebar-user{font-family:'DM Mono',monospace;font-size:0.58rem;letter-spacing:0.08em;color:rgba(255,255,255,0.3);margin-bottom:0.5rem;word-break:break-all;}

/* MAIN */
.main-area{margin-left:var(--sidebar-w);min-height:100vh;background:var(--bg);}
.page-header{padding:1.5rem 2rem 1rem;border-bottom:1px solid var(--faint);}
.page-title{font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:700;}
.page-sub{font-family:'DM Mono',monospace;font-size:0.58rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--dim);margin-top:0.2rem;}
.page-content{padding:1.5rem 2rem;}

/* STAT CARDS */
.stats-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:1rem;margin-bottom:1.5rem;}
.stat-card{background:var(--white);border:1px solid var(--faint);padding:1.2rem;text-align:center;border-top:3px solid var(--ink);}
.stat-num{font-family:'Playfair Display',serif;font-size:2rem;font-weight:900;color:var(--gold);display:block;line-height:1;}
.stat-lbl{font-family:'DM Mono',monospace;font-size:0.52rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--dim);margin-top:0.3rem;display:block;}

/* GRID LAYOUTS */
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
.grid3{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;}

/* SECTION LABEL */
.section-label{font-family:'DM Mono',monospace;font-size:0.58rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--gold);display:flex;align-items:center;gap:0.6rem;margin-bottom:0.8rem;}
.section-label::before{content:'';display:block;width:20px;height:1px;background:var(--gold);}

/* PROGRESS BAR */
.progress-bar{height:6px;background:var(--faint);overflow:hidden;}
.progress-fill{height:100%;background:var(--gold);transition:width 0.5s;}

/* TABS */
.tabs{display:flex;border-bottom:2px solid var(--faint);margin-bottom:1.5rem;}
.tab{font-family:'DM Mono',monospace;font-size:0.58rem;letter-spacing:0.12em;text-transform:uppercase;padding:0.7rem 1.2rem;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;color:var(--dim);transition:all 0.15s;}
.tab.active{color:var(--ink);border-bottom-color:var(--gold);}
.tab:hover:not(.active){color:var(--ink);}

/* CHAT */
.chat-area{display:flex;flex-direction:column;height:calc(100vh - 280px);min-height:400px;}
.chat-messages{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:0.8rem;background:var(--white);border:1px solid var(--faint);}
.chat-bubble{max-width:80%;padding:0.8rem 1rem;font-size:0.88rem;line-height:1.65;}
.chat-bubble.user{background:var(--ink);color:#faf7f2;align-self:flex-end;}
.chat-bubble.coach{background:var(--cream);color:var(--ink);align-self:flex-start;border:1px solid var(--faint);}
.chat-bubble.coach pre{white-space:pre-wrap;font-family:'DM Mono',monospace;font-size:0.78rem;background:rgba(0,0,0,0.05);padding:0.5rem;margin-top:0.4rem;}
.chat-input-row{display:flex;gap:0.5rem;margin-top:0.5rem;}
.chat-input{flex:1;padding:0.7rem 1rem;border:1px solid var(--faint);font-family:'Jost',sans-serif;font-size:0.9rem;outline:none;}
.chat-input:focus{border-color:var(--gold);}
.typing{display:flex;gap:0.3rem;align-items:center;padding:0.8rem 1rem;align-self:flex-start;}
.typing span{width:7px;height:7px;border-radius:50%;background:var(--gold);animation:bounce 1.2s infinite;}
.typing span:nth-child(2){animation-delay:0.2s;}
.typing span:nth-child(3){animation-delay:0.4s;}
@keyframes bounce{0%,80%,100%{transform:translateY(0);}40%{transform:translateY(-6px);}}

/* SETUP SCREEN */
.setup-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--bg);}
.setup-box{max-width:480px;width:100%;padding:2.5rem;background:var(--white);border:1px solid var(--faint);border-top:4px solid var(--gold);}
.setup-title{font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:700;margin-bottom:0.3rem;}
.setup-title em{font-style:italic;color:var(--gold);}

/* LOGIN */
.login-screen{min-height:100vh;display:grid;grid-template-columns:1fr 1fr;}
.login-left{background:var(--ink);color:#faf7f2;display:flex;flex-direction:column;justify-content:center;padding:3rem;}
.login-right{display:flex;align-items:center;justify-content:center;padding:2rem;}
.login-box{width:100%;max-width:380px;}
.login-form-title{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;margin-bottom:1.5rem;}

/* EMPTY STATE */
.empty-state{text-align:center;padding:3rem 1rem;color:var(--dim);}
.empty-icon{font-size:2.5rem;margin-bottom:0.8rem;opacity:0.4;}
.empty-text{font-family:'Playfair Display',serif;font-size:1rem;font-style:italic;margin-bottom:1rem;}

/* ACCORDION */
.accordion-item{border:1px solid var(--faint);margin-bottom:0.5rem;}
.accordion-header{padding:1rem 1.2rem;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:0.92rem;}
.accordion-header:hover{background:var(--cream);}
.accordion-body{padding:0 1.2rem 1rem;font-size:0.88rem;line-height:1.7;color:#3a3020;}
.accordion-body ul{padding-left:1.2rem;margin-top:0.5rem;}
.accordion-body li{margin-bottom:0.3rem;}

/* SCROLLBAR */
::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-track{background:var(--faint);}
::-webkit-scrollbar-thumb{background:var(--dim);}

/* RESPONSIVE */
@media(max-width:768px){
  .sidebar{transform:translateX(-100%);transition:transform 0.25s;}
  .sidebar.open{transform:translateX(0);}
  .main-area{margin-left:0;}
  .login-screen{grid-template-columns:1fr;}
  .login-left{display:none;}
  .grid2{grid-template-columns:1fr;}
}

.divider{border:none;border-top:1px solid var(--faint);margin:1.2rem 0;}
.copybox{background:var(--ink);color:#e0d8d0;font-family:'DM Mono',monospace;font-size:0.72rem;padding:1rem;overflow-x:auto;line-height:1.6;}
.info-box{background:var(--cream);border-left:4px solid var(--gold);padding:1rem 1.2rem;font-size:0.88rem;line-height:1.65;margin-bottom:1rem;}
.info-box strong{display:block;font-family:'DM Mono',monospace;font-size:0.55rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--gold);margin-bottom:0.3rem;}
</style>
<script>
// Pre-seed credentials
var SM_URL = 'https://gpktuflimoqeyxtwadsy.supabase.co';
var SM_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdwa3R1ZmxpbW9xZXl4dHdhZHN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2ODM2MDEsImV4cCI6MjA4NzI1OTYwMX0.q3RMeKEo17qXgt-a9ljtMfKJ46etHy4_rrj1cs64A4U';
var SM_COACH = 'https://gpktuflimoqeyxtwadsy.supabase.co/functions/v1/coach';
try{
  localStorage.setItem('sm_url', SM_URL);
  localStorage.setItem('sm_key', SM_KEY);
  localStorage.setItem('sm_coach', SM_COACH);
}catch(e){}
</script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// â”€â”€ SUPABASE CLIENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Client created in plain <script> tag to avoid window.supabase naming conflict
let _smClient = null;
function getSupabase() { return _smClient; }
function getAnonKey() {
  // Use the anon key for edge function auth - simpler and more reliable than session JWT
  return localStorage.getItem('sm_key') || '';
}
function initSupabase(url, key) {
  if (_smClient) return _smClient;
  // window.supabase is set by the UMD CDN script (var supabase = ...)
  // We access it via window to avoid shadowing by Babel's 'let supabase'
  const lib = window['supabase'];
  if (!lib || !lib.createClient) {
    throw new Error('Supabase CDN not loaded. Check network tab for CDN errors.');
  }
  _smClient = lib.createClient(url, key);
  return _smClient;
}

// â”€â”€ TOAST SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ToastContainer({ toasts }) {
  return (
    <div className="toast-container">
      {toasts.map(t => (
        <div key={t.id} className={`toast toast-${t.type}`}>{t.msg}</div>
      ))}
    </div>
  );
}
function useToast() {
  const [toasts, setToasts] = useState([]);
  const add = (msg, type='success') => {
    const id = Date.now();
    setToasts(p => [...p, {id, msg, type}]);
    setTimeout(() => setToasts(p => p.filter(t => t.id !== id)), 3500);
  };
  return { toasts, toast: add };
}

// â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Modal({ open, onClose, title, children, wide }) {
  if (!open) return null;
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" style={wide?{maxWidth:800}:{}} onClick={e=>e.stopPropagation()}>
        <div className="modal-header">
          <div className="modal-title serif">{title}</div>
          <button className="modal-close" onClick={onClose}>âœ•</button>
        </div>
        {children}
      </div>
    </div>
  );
}

// â”€â”€ DAYS UNTIL GRADUATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function daysUntil(dateStr) {
  const target = new Date(dateStr);
  const now = new Date();
  return Math.ceil((target - now) / (1000*60*60*24));
}

// â”€â”€ SETUP SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function SetupScreen({ onSetup }) {
  const [url, setUrl] = useState('');
  const [key, setKey] = useState('');
  const [coachUrl, setCoachUrl] = useState('');
  const [err, setErr] = useState('');

  const stored = () => {
    const u = localStorage.getItem('sm_url');
    const k = localStorage.getItem('sm_key');
    const c = localStorage.getItem('sm_coach');
    if(u&&k) { setUrl(u); setKey(k); setCoachUrl(c||''); }
  };
  useEffect(stored, []);

  const save = () => {
    if(!url.trim()||!key.trim()) { setErr('Supabase URL and Anon Key are required.'); return; }
    localStorage.setItem('sm_url', url.trim());
    localStorage.setItem('sm_key', key.trim());
    localStorage.setItem('sm_coach', coachUrl.trim());
    initSupabase(url.trim(), key.trim());
    onSetup({ url: url.trim(), key: key.trim(), coachUrl: coachUrl.trim() });
  };

  return (
    <div className="setup-screen">
      <div className="setup-box">
        <div style={{marginBottom:'1.5rem'}}>
          <div className="mono" style={{fontSize:'0.58rem',letterSpacing:'0.2em',textTransform:'uppercase',color:'var(--gold)',marginBottom:'0.5rem'}}>First Time Setup</div>
          <h1 className="setup-title">Sloan<em>Melia</em></h1>
          <p style={{color:'var(--dim)',fontSize:'0.88rem',marginTop:'0.3rem'}}>Enter your Supabase credentials to get started. Find these in your Supabase project â†’ Settings â†’ API.</p>
        </div>

        <div className="mb2">
          <label className="label">Supabase Project URL *</label>
          <input className="input" value={url} onChange={e=>setUrl(e.target.value)} placeholder="https://your-project.supabase.co"/>
        </div>
        <div className="mb2">
          <label className="label">Supabase Anon (Public) Key *</label>
          <input className="input" value={key} onChange={e=>setKey(e.target.value)} placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6Ikp..."/>
        </div>
        <div className="mb2">
          <label className="label">Coach Edge Function URL (optional â€” add later)</label>
          <input className="input" value={coachUrl} onChange={e=>setCoachUrl(e.target.value)} placeholder="https://your-project.supabase.co/functions/v1/coach"/>
          <div style={{fontSize:'0.75rem',color:'var(--dim)',marginTop:'0.3rem'}}>The AI Coach works once you deploy the Edge Function. You can skip this and add it later in the Coach module.</div>
        </div>

        {err && <div style={{color:'var(--red)',fontSize:'0.82rem',marginBottom:'0.8rem'}}>{err}</div>}
        <button className="btn btn-gold w100" onClick={save}>Launch SloanMelia â†’</button>

        <div style={{marginTop:'1.5rem',borderTop:'1px solid var(--faint)',paddingTop:'1rem'}}>
          <div style={{fontSize:'0.75rem',color:'var(--dim)',lineHeight:1.6}}>
            <strong style={{display:'block',marginBottom:'0.3rem'}}>Don't have Supabase yet?</strong>
            1. Go to <strong>supabase.com</strong> â†’ New Project<br/>
            2. Name it <strong>sloanmelia</strong><br/>
            3. Go to Project Settings â†’ API<br/>
            4. Copy the Project URL and anon key above
          </div>
        </div>
      </div>
    </div>
  );
}

// â”€â”€ LOGIN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LoginScreen({ onLogin, toast }) {
  const [email, setEmail] = useState('');
  const [pw, setPw] = useState('');
  const [mode, setMode] = useState('login'); // login | signup
  const [loading, setLoading] = useState(false);

  const submit = async () => {
    if(!email||!pw) return;
    setLoading(true);
    try {
      const sb = getSupabase();
      let res;
      if(mode==='login') {
        res = await sb.auth.signInWithPassword({email, password:pw});
      } else {
        res = await sb.auth.signUp({email, password:pw});
      }
      if(res.error) { toast(res.error.message,'error'); }
      else { 
        if(mode==='signup') toast('Account created! Check email to verify.','success');
        else onLogin(res.data.user);
      }
    } catch(e) { toast('Connection error. Check your Supabase credentials.','error'); }
    setLoading(false);
  };

  return (
    <div className="login-screen">
      <div className="login-left">
        <div style={{marginBottom:'1rem'}}>
          <div className="mono" style={{fontSize:'0.55rem',letterSpacing:'0.25em',textTransform:'uppercase',color:'rgba(200,146,42,0.8)',marginBottom:'1rem'}}>sloanmelia.com</div>
          <div style={{fontFamily:'Playfair Display, serif',fontSize:'3rem',fontWeight:900,lineHeight:1.05,marginBottom:'0.5rem'}}>
            Sloan<br/><em style={{color:'var(--gold)'}}>Melia</em>
          </div>
          <div style={{fontFamily:'Playfair Display, serif',fontStyle:'italic',fontSize:'1.1rem',color:'rgba(255,255,255,0.5)',marginBottom:'2rem'}}>From Senior Year to Dr. Smith</div>
        </div>
        <div style={{display:'flex',flexDirection:'column',gap:'0.8rem'}}>
          {['AI College Coach','Document Vault','College Tracker','Financial Aid Hub','Study Library'].map(f=>(
            <div key={f} style={{display:'flex',alignItems:'center',gap:'0.7rem',fontSize:'0.85rem',color:'rgba(255,255,255,0.6)'}}>
              <span style={{color:'var(--gold)'}}>âœ“</span> {f}
            </div>
          ))}
        </div>
      </div>
      <div className="login-right">
        <div className="login-box">
          <div style={{marginBottom:'1.5rem'}}>
            <div className="mono" style={{fontSize:'0.55rem',letterSpacing:'0.18em',textTransform:'uppercase',color:'var(--gold)',marginBottom:'0.4rem'}}>
              {mode==='login'?'Welcome Back':'Create Account'}
            </div>
            <h2 className="login-form-title serif">{mode==='login'?'Sign In':'Get Started'}</h2>
          </div>

          <div className="mb2">
            <label className="label">Email</label>
            <input className="input" type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="sloan@sloanmelia.com" onKeyDown={e=>e.key==='Enter'&&submit()}/>
          </div>
          <div className="mb2">
            <label className="label">Password</label>
            <input className="input" type="password" value={pw} onChange={e=>setPw(e.target.value)} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onKeyDown={e=>e.key==='Enter'&&submit()}/>
          </div>

          <button className="btn btn-primary w100 mt1" onClick={submit} disabled={loading} style={{justifyContent:'center'}}>
            {loading?'...':(mode==='login'?'Sign In â†’':'Create Account â†’')}
          </button>

          <div style={{textAlign:'center',marginTop:'1rem',fontSize:'0.82rem',color:'var(--dim)'}}>
            {mode==='login'?'New here?':'Already have an account?'}{' '}
            <span style={{color:'var(--gold)',cursor:'pointer',fontWeight:600}} onClick={()=>setMode(m=>m==='login'?'signup':'login')}>
              {mode==='login'?'Create account':'Sign in'}
            </span>
          </div>
        </div>
      </div>
    </div>
  );
}

// â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NAV_ITEMS = [
  { id:'home', icon:'ğŸ ', label:'Home' },
  { id:'library', icon:'ğŸ“š', label:'Study Library' },
  { id:'vault', icon:'ğŸ“', label:'Document Vault' },
  { id:'tracker', icon:'ğŸ“', label:'College Tracker' },
  { id:'achievements', icon:'â­', label:'Achievements' },
  { id:'financial', icon:'ğŸ’°', label:'Financial Aid' },
  { id:'gpa', icon:'ğŸ“Š', label:'GPA Tracker' },
  { id:'profile', icon:'ğŸŒ', label:'Profile Builder' },
  { id:'coach', icon:'ğŸ¤–', label:'Coach', special:true },
];

function Sidebar({ page, onNav, user, onSignOut }) {
  return (
    <div className="sidebar">
      <div className="sidebar-logo">
        <div className="monogram">SM</div>
        <div className="app-name">SloanMelia</div>
        <div className="app-sub">College Command Center</div>
      </div>
      <nav className="sidebar-nav">
        {NAV_ITEMS.map(item => (
          <div key={item.id} className={`nav-item${page===item.id?' active':''}${item.special?' coach-nav':''}`} onClick={()=>onNav(item.id)}>
            <span className="nav-icon">{item.icon}</span>
            <span className="nav-label">{item.label}</span>
          </div>
        ))}
      </nav>
      <div className="sidebar-footer">
        <a
          href="https://sloanmelia.com/index.html"
          target="_blank"
          rel="noopener noreferrer"
          style={{
            display:'flex',alignItems:'center',gap:'0.5rem',
            padding:'0.5rem 0.6rem',marginBottom:'0.5rem',
            background:'rgba(200,146,42,0.12)',
            border:'1px solid rgba(200,146,42,0.3)',
            borderRadius:'6px',textDecoration:'none',
            color:'var(--gold)',fontSize:'0.78rem',fontWeight:600,
            transition:'background 0.15s'
          }}
          onMouseEnter={e=>e.currentTarget.style.background='rgba(200,146,42,0.22)'}
          onMouseLeave={e=>e.currentTarget.style.background='rgba(200,146,42,0.12)'}
        >
          <span>ğŸŒ</span>
          <span>View Public Profile</span>
          <span style={{marginLeft:'auto',opacity:0.6}}>â†—</span>
        </a>
        <div className="sidebar-user">{user?.email}</div>
        <button className="btn btn-ghost w100" style={{color:'rgba(255,255,255,0.35)',textAlign:'left',paddingLeft:0}} onClick={onSignOut}>Sign Out</button>
      </div>
    </div>
  );
}

// â”€â”€ HOME MODULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ GPA SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GRADE_POINTS = {
  'A+':4.0,'A':4.0,'A-':3.7,
  'B+':3.3,'B':3.0,'B-':2.7,
  'C+':2.3,'C':2.0,'C-':1.7,
  'D+':1.3,'D':1.0,'D-':0.7,
  'F':0.0,'WF':0.0,'P':null,'W':null,'I':null
};
function gradeToPoints(letter) {
  if(!letter) return null;
  return GRADE_POINTS[letter.trim().toUpperCase()] ?? null;
}
// â”€â”€ GPA CALCULATION ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1. UNWEIGHTED â€” straight 4.0 scale, no bonuses, every class equal
function calcGPA(grades) {
  const eligible = (grades||[]).filter(g => g.grade_points !== null && g.grade_points !== undefined && parseFloat(g.credit_hours) > 0);
  if(!eligible.length) return null;
  const pts = eligible.reduce((s,g)=>s + (parseFloat(g.grade_points) * parseFloat(g.credit_hours)), 0);
  const cr  = eligible.reduce((s,g)=>s + parseFloat(g.credit_hours), 0);
  return cr > 0 ? Math.round((pts/cr)*1000)/1000 : null;
}

// 2. WEIGHTED â€” AP courses +1.0 bonus, Honors/CP courses +0.5 bonus (College Board standard)
//    e.g. A in AP class = 5.0, A in Honors = 4.5, A in regular = 4.0
//    Scale goes above 4.0 â€” this shows course rigor
function calcWeightedGPA(grades) {
  const eligible = (grades||[]).filter(g => g.grade_points !== null && g.grade_points !== undefined && parseFloat(g.credit_hours) > 0);
  if(!eligible.length) return null;
  const pts = eligible.reduce((s,g)=>{
    const bonus = g.is_ap ? 1.0 : g.is_honors ? 0.5 : 0;
    const weighted = Math.min(parseFloat(g.grade_points) + bonus, 5.0); // cap at 5.0
    return s + (weighted * parseFloat(g.credit_hours));
  }, 0);
  const cr = eligible.reduce((s,g)=>s + parseFloat(g.credit_hours), 0);
  return cr > 0 ? Math.round((pts/cr)*1000)/1000 : null;
}

// 3. CORE ACADEMIC â€” unweighted but electives stripped out
//    Only counts: English, Math, Science, Social Studies, Foreign Language
//    Used by UC system and many competitive universities
const CORE_KEYWORDS = [
  'english','math','algebra','geometry','calculus','statistics','biology','chemistry',
  'physics','science','history','social','geography','spanish','french','language',
  'ap ','psychology','sociology','economics','government','writing','literature'
];
function isCoreAcademic(courseName) {
  const lower = (courseName||'').toLowerCase();
  return CORE_KEYWORDS.some(kw => lower.includes(kw));
}
function calcCoreGPA(grades) {
  const core = (grades||[]).filter(g =>
    g.grade_points !== null && g.grade_points !== undefined &&
    parseFloat(g.credit_hours) > 0 &&
    isCoreAcademic(g.course_name)
  );
  if(!core.length) return null;
  const pts = core.reduce((s,g)=>s + (parseFloat(g.grade_points) * parseFloat(g.credit_hours)), 0);
  const cr  = core.reduce((s,g)=>s + parseFloat(g.credit_hours), 0);
  return cr > 0 ? Math.round((pts/cr)*1000)/1000 : null;
}

function HomeModule({ onNav, user }) {
  const [stats, setStats] = useState({docs:0, schools:0, achievements:0, gpa:null, totalCourses:0});
  const graduation = new Date('2026-05-15');
  const days = Math.max(0, Math.ceil((graduation - new Date())/(1000*60*60*24)));

  const loadStats = () => {
    const sb = getSupabase();
    const uid = user?.id;
    if(!uid) return;
    Promise.all([
      sb.from('documents').select('id',{count:'exact'}).eq('user_id',uid),
      sb.from('college_applications').select('id',{count:'exact'}).eq('user_id',uid),
      sb.from('achievements').select('id',{count:'exact'}).eq('user_id',uid),
      sb.from('grades').select('grade_points,credit_hours').eq('user_id',uid),
    ]).then(([d,c,a,g])=>{
      const gpaUnweighted = calcGPA(g.data||[]);
      const gpaWeighted    = calcWeightedGPA(g.data||[]);
      setStats({docs:d.count||0, schools:c.count||0, achievements:a.count||0,
                gpa:gpaWeighted, gpaUnweighted, totalCourses:(g.data||[]).length});
    }).catch(()=>{});
  };

  useEffect(()=>{ loadStats(); },[user]);

  const gpaColor = stats.gpa === null ? 'var(--dim)'
    : stats.gpa >= 3.7 ? '#059669'
    : stats.gpa >= 3.3 ? '#d97706'
    : '#dc2626';

  return (
    <div>
      <div className="page-header">
        <div className="page-title serif">Welcome back, <em style={{color:'var(--gold)'}}>Sloan</em> ğŸ‘‹</div>
        <div className="page-sub">Class of 2026 Â· Alton High School Â· Future Dr. Smith</div>
      </div>
      <div className="page-content">

        {/* Stats row â€” GPA is now live from DB */}
        <div className="stats-row">
          <div className="stat-card" style={{borderTopColor: gpaColor}}>
            <span className="stat-num" style={{color: gpaColor}}>
              {stats.gpa !== null ? stats.gpa.toFixed(3) : 'â€”'}
            </span>
            <span className="stat-lbl">
              Weighted GPA
              {stats.gpaUnweighted !== null && <span style={{display:'block',fontSize:'0.7rem',color:'var(--dim)'}}>Unweighted: {stats.gpaUnweighted?.toFixed(3)}</span>}
              {stats.totalCourses > 0 && <span style={{display:'block',fontSize:'0.68rem',color:'var(--dim)'}}>{stats.totalCourses} courses</span>}
            </span>
          </div>
          <div className="stat-card"><span className="stat-num">{stats.docs}</span><span className="stat-lbl">Documents Uploaded</span></div>
          <div className="stat-card"><span className="stat-num">{stats.schools}</span><span className="stat-lbl">Schools Tracked</span></div>
          <div className="stat-card" style={{borderTopColor:'var(--gold)'}}><span className="stat-num">{days}</span><span className="stat-lbl">Days to Graduation</span></div>
        </div>

        <div className="section-label">Quick Actions</div>
        <div className="grid3" style={{marginBottom:'1.5rem'}}>
          {[
            {icon:'ğŸ“Š',title:'Update GPA',desc:'Add courses or upload transcript to recalculate',action:'gpa',color:'#059669'},
            {icon:'ğŸ¤–',title:'Ask Your Coach',desc:'Get help with forms, essays, and applications',action:'coach',color:'var(--gold)'},
            {icon:'ğŸ“',title:'Upload Document',desc:'Add transcripts, recommendation letters, and more',action:'vault',color:'var(--teal)'},
          ].map(a=>(
            <div key={a.action} className="card" style={{borderTop:`3px solid ${a.color}`,cursor:'pointer'}} onClick={()=>onNav(a.action)}>
              <div style={{fontSize:'1.5rem',marginBottom:'0.5rem'}}>{a.icon}</div>
              <div className="card-title" style={{fontSize:'0.97rem'}}>{a.title}</div>
              <div style={{fontSize:'0.82rem',color:'var(--dim)',marginTop:'0.3rem'}}>{a.desc}</div>
            </div>
          ))}
        </div>

        <div className="card" style={{borderTop:'3px solid var(--gold)',marginBottom:'1rem',display:'flex',alignItems:'center',justifyContent:'space-between',padding:'1rem 1.2rem'}}>
          <div>
            <div style={{fontWeight:700,fontSize:'0.95rem',marginBottom:'0.2rem'}}>ğŸŒ Your Public Profile</div>
            <div style={{fontSize:'0.82rem',color:'var(--dim)'}}>sloanmelia.com â€” what colleges and recruiters see</div>
          </div>
          <a href="https://sloanmelia.com/index.html" target="_blank" rel="noopener noreferrer"
            className="btn btn-gold"
            style={{textDecoration:'none',whiteSpace:'nowrap',flexShrink:0,marginLeft:'1rem'}}>
            View Profile â†—
          </a>
        </div>

        <div className="info-box">
          <strong>Your Path to Dr. Smith</strong>
          Senior Year (now) â†’ Bachelor's in Psychology (2026â€“2030) â†’ Master's Degree (2030â€“2032) â†’ PhD in Forensic Psychology (2032â€“2036) â†’ Licensed Forensic Psychologist
        </div>
      </div>
    </div>
  );
}


// â”€â”€ STUDY LIBRARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STUDY_TOPICS = [
  // â”€â”€ CORE FORENSIC (8) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {id:1,title:'Brain & Neuroscience',cat:'Core Forensic',
   color:'#7c3aed',bg:'#f5f3ff',
   desc:'The biological foundation of behavior, emotion, and the criminal mind.',
   poster:'https://sloanmelia.com/poster1-brain.html',
   openstax:'https://openstax.org/books/psychology-2e/pages/3-1-human-genetics',
   openstaxLabel:'Psychology 2e Â· Ch 3: Biopsychology',
   concepts:['Limbic system and emotional regulation','Prefrontal cortex and impulse control','Neuroplasticity and trauma','Brain imaging in forensic contexts','Psychopathy and brain differences','Neurotransmitters and behavior']},
  {id:2,title:'DSM-5 Diagnostic Reference',cat:'Core Forensic',
   color:'#dc2626',bg:'#fef2f2',
   desc:'Mental disorder classification system used in forensic evaluations.',
   poster:'https://sloanmelia.com/poster2-dsm5.html',
   openstax:'https://openstax.org/books/psychology-2e/pages/15-1-what-are-psychological-disorders',
   openstaxLabel:'Psychology 2e Â· Ch 15: Psychological Disorders',
   concepts:['Multiaxial assessment replaced by specifiers','Personality disorder clusters A/B/C','Psychotic disorder spectrum','Trauma and stressor-related disorders','Substance use disorder criteria','Malingering vs genuine disorder']},
  {id:3,title:'Theorists Timeline',cat:'Core Forensic',
   color:'#d97706',bg:'#fffbeb',
   desc:'From Freud to modern forensic psychology pioneers.',
   poster:'https://sloanmelia.com/poster3-theorists.html',
   openstax:'https://openstax.org/books/psychology-2e/pages/1-2-history-of-psychology',
   openstaxLabel:'Psychology 2e Â· Ch 1: History of Psychology',
   concepts:['Freud: unconscious and defense mechanisms','Skinner: behavioral reinforcement','Bandura: social learning theory','Kohlberg: moral development stages','Hare: psychopathy assessment (PCL-R)','Seligman: learned helplessness']},
  {id:4,title:'Research Methods & Statistics',cat:'Core Forensic',
   color:'#0369a1',bg:'#f0f9ff',
   desc:'Scientific foundation of psychological research.',
   poster:'https://sloanmelia.com/poster4-research.html',
   openstax:'https://openstax.org/books/psychology-2e/pages/2-1-why-is-research-important',
   openstaxLabel:'Psychology 2e Â· Ch 2: Research Methods',
   concepts:['Experimental vs correlational design','Validity: internal and external','Reliability: test-retest, inter-rater','Statistical significance (p-value)','Effect size and practical significance','Ethical research principles (APA)']},
  {id:5,title:'Defense Mechanisms',cat:'Core Forensic',
   color:'#be185d',bg:'#fdf2f8',
   desc:'Psychological defenses relevant to criminal behavior analysis.',
   poster:'https://sloanmelia.com/poster5-defense.html',
   openstax:'https://openstax.org/books/psychology-2e/pages/11-3-defense-mechanisms',
   openstaxLabel:'Psychology 2e Â· Ch 11: Defense Mechanisms',
   concepts:['Repression: unconscious blocking','Rationalization: justifying actions','Projection: attributing to others','Denial: refusing to acknowledge','Displacement: redirecting emotion','Sublimation: channeling productively']},
  {id:6,title:'Human Development',cat:'Core Forensic',
   color:'#059669',bg:'#f0fdf4',
   desc:'Lifespan development theories critical to forensic assessment.',
   poster:'https://sloanmelia.com/poster6-development.html',
   openstax:'https://openstax.org/books/psychology-2e/pages/9-1-what-is-lifespan-development',
   openstaxLabel:'Psychology 2e Â· Ch 9: Lifespan Development',
   concepts:["Erikson's 8 psychosocial stages","Piaget's cognitive stages","Vygotsky's zone of proximal development",'Attachment theory (Bowlby)','Adverse childhood experiences (ACEs)','Adolescent brain development']},
  {id:7,title:'Cognitive Biases',cat:'Core Forensic',
   color:'#9333ea',bg:'#faf5ff',
   desc:'How thinking errors affect judgment, perception, and testimony.',
   poster:'https://sloanmelia.com/poster7-biases.html',
   openstax:'https://openstax.org/books/psychology-2e/pages/7-3-problem-solving',
   openstaxLabel:'Psychology 2e Â· Ch 7: Thinking & Intelligence',
   concepts:['Confirmation bias in investigation','Hindsight bias in evaluation','Availability heuristic','Anchoring effect in assessment','Eyewitness memory fallibility','Implicit bias in the justice system']},
  {id:8,title:'APA Ethics Code',cat:'Core Forensic',
   color:'#1d4ed8',bg:'#eff6ff',
   desc:'Professional ethical obligations guiding all psychologists.',
   poster:'https://sloanmelia.com/poster8-ethics.html',
   openstax:'https://openstax.org/books/psychology-2e/pages/1-3-contemporary-psychology',
   openstaxLabel:'Psychology 2e Â· Ch 1: Ethics in Psychology',
   concepts:['Informed consent requirements','Confidentiality and its limits','Dual relationship avoidance','Competence boundaries','Accurate test reporting','Mandatory reporting obligations']},
  // â”€â”€ SUPPORTING COURSEWORK (8) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {id:9,title:'Biology & Physiology',cat:'Supporting',
   color:'#0d9488',bg:'#f0fdfa',
   desc:'Body systems that support psychological function.',
   poster:'https://sloanmelia.com/support1-biology.html',
   openstax:'https://openstax.org/books/anatomy-and-physiology-2e/pages/1-introduction',
   openstaxLabel:'Anatomy & Physiology 2e Â· Full Textbook',
   concepts:['Autonomic nervous system responses','HPA axis and stress response','Sleep and mental health connection','Nutrition and brain function','Genetic influences on behavior','Immune-brain interactions']},
  {id:10,title:'Sociology & Social Theory',cat:'Supporting',
   color:'#c2410c',bg:'#fff7ed',
   desc:'Social forces shaping criminal behavior and justice.',
   poster:'https://sloanmelia.com/support2-sociology.html',
   openstax:'https://openstax.org/books/introduction-sociology-3e/pages/1-introduction',
   openstaxLabel:'Introduction to Sociology 3e Â· Full Textbook',
   concepts:["Durkheim's anomie theory","Merton's strain theory",'Labeling theory and stigma','Social control theory','Intersectionality in justice','Recidivism and social factors']},
  {id:11,title:'Philosophy of Mind',cat:'Supporting',
   color:'#6d28d9',bg:'#f5f3ff',
   desc:'Consciousness, free will, and moral responsibility.',
   poster:'https://sloanmelia.com/support3-philosophy.html',
   openstax:'https://openstax.org/books/introduction-philosophy/pages/1-introduction',
   openstaxLabel:'Introduction to Philosophy Â· Full Textbook',
   concepts:['Determinism vs free will debate','Consciousness and self-awareness','Personal identity over time','Moral responsibility standards','The mind-body problem','Competency and culpability standards']},
  {id:12,title:'Pharmacology Basics',cat:'Supporting',
   color:'#0f766e',bg:'#f0fdfa',
   desc:'Psychoactive substances and their behavioral effects.',
   poster:'https://sloanmelia.com/support4-pharmacology.html',
   openstax:'https://openstax.org/books/psychology-2e/pages/16-3-approaches-to-treating-psychological-disorders',
   openstaxLabel:'Psychology 2e Â· Ch 16: Biomedical Therapy',
   concepts:['CNS stimulants and depressants','Antipsychotic mechanisms','Antidepressant classes (SSRIs etc.)','Substance dependence physiology','Drug-induced psychosis','Medication compliance in forensic settings']},
  {id:13,title:'Law & Psychology Interface',cat:'Supporting',
   color:'#1e40af',bg:'#eff6ff',
   desc:'How psychological science enters the legal system.',
   poster:'https://sloanmelia.com/support5-law.html',
   openstax:'https://openstax.org/books/psychology-2e/pages/1-introduction',
   openstaxLabel:'Psychology 2e Â· Forensic Applications',
   concepts:['Competency to stand trial standards','Criminal responsibility (mens rea)','Insanity defense standards','Risk assessment instruments','Expert witness role and limits','Miranda rights and interrogation psychology']},
  {id:14,title:'Communication & Testimony',cat:'Supporting',
   color:'#9f1239',bg:'#fff1f2',
   desc:'Expert witness skills and forensic report writing.',
   poster:'https://sloanmelia.com/support6-comm-write-admin.html',
   openstax:'https://openstax.org/books/psychology-2e/pages/1-introduction',
   openstaxLabel:'Psychology 2e Â· Professional Communication',
   concepts:['Report structure and objectivity','Cross-examination preparation','Translating jargon for juries','Daubert/Frye admissibility standards','Ethical boundaries in testimony','Non-verbal communication awareness']},
  {id:15,title:'Academic Writing',cat:'Supporting',
   color:'#065f46',bg:'#f0fdf4',
   desc:'Research paper and report writing standards for psychology.',
   poster:'https://sloanmelia.com/support6-comm-write-admin.html',
   openstax:'https://openstax.org/books/writing-guide/pages/1-unit-introduction',
   openstaxLabel:'Writing Guide with Handbook Â· Full Textbook',
   concepts:['APA 7th edition formatting','Thesis statement construction','Literature review methodology','Citation and plagiarism rules','Abstract writing','Statistical results reporting']},
  {id:16,title:'Program Administration',cat:'Supporting',
   color:'#374151',bg:'#f9fafb',
   desc:'Clinical and forensic program management fundamentals.',
   poster:'https://sloanmelia.com/support6-comm-write-admin.html',
   openstax:'https://openstax.org/books/introduction-business/pages/1-introduction',
   openstaxLabel:'Introduction to Business Â· Org Management',
   concepts:['HIPAA and confidentiality rules','Supervision and consultation ethics','Case documentation standards','Crisis intervention protocols','Team communication frameworks','Forensic unit security protocols']},
];

function LibraryModule({ onNav, coachUrl }) {
  const [search, setSearch] = useState('');
  const [selected, setSelected] = useState(null);
  const [activeTab, setActiveTab] = useState('all');
  const filtered = STUDY_TOPICS.filter(t =>
    (activeTab === 'all' || t.cat === activeTab) &&
    (t.title.toLowerCase().includes(search.toLowerCase()) ||
     t.cat.toLowerCase().includes(search.toLowerCase()) ||
     t.desc.toLowerCase().includes(search.toLowerCase()))
  );

  return (
    <div>
      <div className="page-header">
        <div className="page-title serif">Study <em style={{color:'var(--gold)'}}>Library</em></div>
        <div className="page-sub">16 forensic psychology modules Â· Click any card to study Â· OpenStax textbooks linked</div>
      </div>
      <div className="page-content">

        {/* Search + filter */}
        <div style={{display:'flex',gap:'0.6rem',marginBottom:'1.2rem',flexWrap:'wrap',alignItems:'center'}}>
          <input className="input" style={{flex:1,minWidth:'180px'}}
            placeholder="Search topics, concepts, keywords..."
            value={search} onChange={e=>setSearch(e.target.value)}/>
          <div style={{display:'flex',gap:'0.4rem'}}>
            {['all','Core Forensic','Supporting'].map(tab=>(
              <button key={tab} onClick={()=>setActiveTab(tab)}
                className="btn btn-sm"
                style={{
                  background: activeTab===tab ? 'var(--ink)' : 'transparent',
                  color: activeTab===tab ? 'var(--cream)' : 'var(--dim)',
                  border: '1px solid var(--border)',
                  fontSize:'0.78rem'
                }}>
                {tab === 'all' ? 'All 16' : tab === 'Core Forensic' ? 'ğŸ”¬ Core (8)' : 'ğŸ“– Supporting (8)'}
              </button>
            ))}
          </div>
        </div>

        {/* Core Forensic section */}
        {(activeTab === 'all' || activeTab === 'Core Forensic') && filtered.filter(t=>t.cat==='Core Forensic').length > 0 && (
          <>
            <div className="section-label" style={{marginBottom:'0.6rem'}}>
              ğŸ”¬ Core Forensic Psychology
            </div>
            <div className="grid3" style={{marginBottom:'1.8rem'}}>
              {filtered.filter(t=>t.cat==='Core Forensic').map(t=>(
                <div key={t.id}
                  className="card"
                  style={{
                    borderTop:`4px solid ${t.color}`,
                    background:t.bg,
                    cursor:'pointer',
                    transition:'transform 0.15s,box-shadow 0.15s'
                  }}
                  onClick={()=>setSelected(t)}
                  onMouseEnter={e=>{e.currentTarget.style.transform='translateY(-2px)';e.currentTarget.style.boxShadow=`0 6px 20px ${t.color}25`;}}
                  onMouseLeave={e=>{e.currentTarget.style.transform='';e.currentTarget.style.boxShadow='';}}
                >
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'0.4rem'}}>
                    <span className="card-label" style={{color:t.color,fontWeight:700}}>Core Forensic</span>
                    <span style={{fontSize:'0.68rem',background:`${t.color}15`,color:t.color,padding:'2px 6px',borderRadius:'4px',fontFamily:'monospace',fontWeight:600}}>
                      #{t.id.toString().padStart(2,'0')}
                    </span>
                  </div>
                  <div className="card-title" style={{color:'var(--ink)',marginBottom:'0.3rem'}}>{t.title}</div>
                  <div style={{fontSize:'0.8rem',color:'var(--dim)',lineHeight:1.5,marginBottom:'0.6rem'}}>{t.desc}</div>
                  <div style={{display:'flex',gap:'0.4rem',flexWrap:'wrap',marginTop:'auto'}}>
                    <span style={{fontSize:'0.7rem',background:t.color,color:'#fff',padding:'2px 7px',borderRadius:'3px',fontWeight:600}}>
                      ğŸ“– OpenStax
                    </span>
                    <span style={{fontSize:'0.7rem',background:'var(--ink)',color:'var(--cream)',padding:'2px 7px',borderRadius:'3px'}}>
                      Study â†’
                    </span>
                  </div>
                </div>
              ))}
            </div>
          </>
        )}

        {/* Supporting section */}
        {(activeTab === 'all' || activeTab === 'Supporting') && filtered.filter(t=>t.cat==='Supporting').length > 0 && (
          <>
            <div className="section-label" style={{marginBottom:'0.6rem'}}>
              ğŸ“– Supporting Coursework
            </div>
            <div className="grid3">
              {filtered.filter(t=>t.cat==='Supporting').map(t=>(
                <div key={t.id}
                  className="card"
                  style={{
                    borderTop:`4px solid ${t.color}`,
                    background:t.bg,
                    cursor:'pointer',
                    transition:'transform 0.15s,box-shadow 0.15s'
                  }}
                  onClick={()=>setSelected(t)}
                  onMouseEnter={e=>{e.currentTarget.style.transform='translateY(-2px)';e.currentTarget.style.boxShadow=`0 6px 20px ${t.color}25`;}}
                  onMouseLeave={e=>{e.currentTarget.style.transform='';e.currentTarget.style.boxShadow='';}}
                >
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'0.4rem'}}>
                    <span className="card-label" style={{color:t.color,fontWeight:700}}>Supporting</span>
                    <span style={{fontSize:'0.68rem',background:`${t.color}15`,color:t.color,padding:'2px 6px',borderRadius:'4px',fontFamily:'monospace',fontWeight:600}}>
                      #{t.id.toString().padStart(2,'0')}
                    </span>
                  </div>
                  <div className="card-title" style={{color:'var(--ink)',marginBottom:'0.3rem'}}>{t.title}</div>
                  <div style={{fontSize:'0.8rem',color:'var(--dim)',lineHeight:1.5,marginBottom:'0.6rem'}}>{t.desc}</div>
                  <div style={{display:'flex',gap:'0.4rem',flexWrap:'wrap',marginTop:'auto'}}>
                    <span style={{fontSize:'0.7rem',background:t.color,color:'#fff',padding:'2px 7px',borderRadius:'3px',fontWeight:600}}>
                      ğŸ“– OpenStax
                    </span>
                    <span style={{fontSize:'0.7rem',background:'var(--ink)',color:'var(--cream)',padding:'2px 7px',borderRadius:'3px'}}>
                      Study â†’
                    </span>
                  </div>
                </div>
              ))}
            </div>
          </>
        )}

        {filtered.length === 0 && (
          <div style={{textAlign:'center',padding:'3rem',color:'var(--dim)'}}>
            No topics match your search. Try a different keyword.
          </div>
        )}

      </div>

      {/* Detail Modal */}
      <Modal open={!!selected} onClose={()=>setSelected(null)} title={selected?.title}>
        {selected && (
          <>
            {/* Color accent bar */}
            <div style={{height:'4px',background:selected.color,borderRadius:'2px',marginBottom:'1rem',marginLeft:'-1.5rem',marginRight:'-1.5rem',width:'calc(100% + 3rem)'}}/>

            <div style={{display:'flex',gap:'0.5rem',marginBottom:'1rem',flexWrap:'wrap'}}>
              <span style={{fontSize:'0.75rem',background:`${selected.color}15`,color:selected.color,padding:'3px 10px',borderRadius:'12px',fontWeight:700}}>
                {selected.cat}
              </span>
              <span style={{fontSize:'0.75rem',background:'var(--cream)',color:'var(--dim)',padding:'3px 10px',borderRadius:'12px',border:'1px solid var(--border)'}}>
                Module #{selected.id.toString().padStart(2,'0')}
              </span>
            </div>

            <p style={{fontSize:'0.9rem',color:'var(--dim)',marginBottom:'1.2rem',lineHeight:1.6}}>{selected.desc}</p>

            <div className="section-label" style={{color:selected.color}}>Key Concepts</div>
            <ul style={{paddingLeft:'1.2rem',marginBottom:'1.5rem'}}>
              {selected.concepts.map((c,i)=>(
                <li key={i} style={{marginBottom:'0.5rem',fontSize:'0.88rem',lineHeight:1.5}}>
                  <span style={{color:selected.color,fontWeight:600}}>â€º</span> {c}
                </li>
              ))}
            </ul>

            <div className="section-label">Resources</div>
            <div style={{display:'flex',gap:'0.6rem',flexWrap:'wrap',marginBottom:'0.8rem',marginTop:'0.5rem'}}>
              {selected.poster && (
                <a href={selected.poster} target="_blank" rel="noopener noreferrer"
                  style={{
                    textDecoration:'none',display:'inline-flex',alignItems:'center',gap:'0.4rem',
                    background:selected.color,color:'#fff',
                    padding:'0.45rem 1rem',borderRadius:'6px',fontSize:'0.83rem',fontWeight:600
                  }}>
                  ğŸ“„ View Reference Poster
                </a>
              )}
              {selected.openstax && (
                <a href={selected.openstax} target="_blank" rel="noopener noreferrer"
                  style={{
                    textDecoration:'none',display:'inline-flex',alignItems:'center',gap:'0.4rem',
                    background:`${selected.color}15`,color:selected.color,
                    border:`1px solid ${selected.color}40`,
                    padding:'0.45rem 1rem',borderRadius:'6px',fontSize:'0.83rem',fontWeight:600
                  }}>
                  ğŸ“š {selected.openstaxLabel || 'OpenStax Textbook'}
                </a>
              )}
            </div>
            <button
              className="btn"
              style={{background:'var(--ink)',color:'var(--cream)',border:'none',width:'100%',marginTop:'0.4rem'}}
              onClick={()=>{setSelected(null);onNav('coach');}}>
              ğŸ¤– Ask Coach About This Topic
            </button>
          </>
        )}
      </Modal>
    </div>
  );
}

const DOC_CATS = ['Transcript','Test Scores','Recommendation Letter','Essay','Certificate','Resume','Financial','Other'];
const CAT_BADGE = {Transcript:'badge-blue','Test Scores':'badge-teal','Recommendation Letter':'badge-gold',Essay:'badge-green',Certificate:'badge-teal',Resume:'badge-gold',Financial:'badge-red',Other:'badge-gray'};

function VaultModule({ user, toast }) {
  const [docs, setDocs] = useState([]);
  const [loading, setLoading] = useState(true);
  const [cat, setCat] = useState('Transcript');
  const [uploading, setUploading] = useState(false);
  const fileRef = useRef();

  const load = async () => {
    const sb = getSupabase();
    const { data } = await sb.from('documents').select('*').eq('user_id', user.id).order('created_at',{ascending:false});
    setDocs(data||[]);
    setLoading(false);
  };
  useEffect(()=>{ load(); },[]);

  const upload = async (file) => {
    if(!file) return;
    if(file.size > 10*1024*1024) { toast('File must be under 10MB','error'); return; }
    setUploading(true);
    const sb = getSupabase();
    const path = `${user.id}/${Date.now()}_${file.name}`;
    const { error: se } = await sb.storage.from('documents').upload(path, file);
    if(se) { toast('Upload failed: '+se.message,'error'); setUploading(false); return; }
    const { error: de } = await sb.from('documents').insert({user_id:user.id,name:file.name,category:cat,file_path:path,file_size:file.size});
    if(de) toast('Saved to storage but DB record failed','warn');
    else toast('Document uploaded!','success');
    setUploading(false);
    load();
  };

  const del = async (doc) => {
    if(!window.confirm('Delete '+doc.name+'?')) return;
    const sb = getSupabase();
    await sb.storage.from('documents').remove([doc.file_path]);
    await sb.from('documents').delete().eq('id',doc.id);
    toast('Document deleted','success');
    load();
  };

  const fmtSize = (bytes) => {
    if(!bytes) return '';
    if(bytes<1024) return bytes+'B';
    if(bytes<1024*1024) return (bytes/1024).toFixed(0)+'KB';
    return (bytes/(1024*1024)).toFixed(1)+'MB';
  };

  return (
    <div>
      <div className="page-header">
        <div className="page-title serif">Document <em style={{color:'var(--gold)'}}>Vault</em></div>
        <div className="page-sub">Securely store all your application documents</div>
      </div>
      <div className="page-content">

        <div className="card" style={{borderTop:'3px solid var(--gold)',marginBottom:'1.5rem'}}>
          <div className="section-label">Upload New Document</div>
          <div style={{marginBottom:'0.8rem'}}>
            <label className="label">Category</label>
            <select className="select" value={cat} onChange={e=>setCat(e.target.value)}>
              {DOC_CATS.map(c=><option key={c}>{c}</option>)}
            </select>
          </div>

          <div
            style={{border:'2px dashed var(--faint)',padding:'2rem',textAlign:'center',cursor:'pointer',background:'var(--bg)'}}
            onClick={()=>fileRef.current.click()}
            onDragOver={e=>{e.preventDefault();e.currentTarget.style.borderColor='var(--gold)';}}
            onDragLeave={e=>{e.currentTarget.style.borderColor='var(--faint)';}}
            onDrop={e=>{e.preventDefault();e.currentTarget.style.borderColor='var(--faint)';upload(e.dataTransfer.files[0]);}}
          >
            <div style={{fontSize:'2rem',marginBottom:'0.5rem'}}>ğŸ“</div>
            <div style={{fontSize:'0.88rem',color:'var(--dim)'}}>Drag & drop or <span style={{color:'var(--gold)',fontWeight:600}}>click to browse</span></div>
            <div style={{fontSize:'0.75rem',color:'var(--dim)',marginTop:'0.3rem'}}>Max 10MB Â· PDF, DOC, JPG, PNG</div>
            {uploading && <div style={{marginTop:'0.5rem',color:'var(--gold)',fontFamily:'DM Mono,monospace',fontSize:'0.65rem',letterSpacing:'0.1em'}}>UPLOADING...</div>}
          </div>
          <input ref={fileRef} type="file" style={{display:'none'}} onChange={e=>upload(e.target.files[0])}/>
        </div>

        {loading ? <div className="empty-state"><div className="typing"><span/><span/><span/></div></div> :
          docs.length===0 ? (
            <div className="empty-state">
              <div className="empty-icon">ğŸ“</div>
              <div className="empty-text">No documents yet</div>
              <div style={{fontSize:'0.82rem',color:'var(--dim)'}}>Upload your transcript, recommendation letters, and resume above</div>
            </div>
          ) : (
            <div>
              <div className="section-label">{docs.length} Document{docs.length!==1?'s':''} Stored</div>
              {docs.map(doc=>(
                <div key={doc.id} className="card" style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'0.5rem',padding:'0.8rem 1.2rem'}}>
                  <div style={{display:'flex',alignItems:'center',gap:'0.8rem'}}>
                    <span style={{fontSize:'1.2rem'}}>ğŸ“„</span>
                    <div>
                      <div style={{fontWeight:600,fontSize:'0.9rem'}}>{doc.name}</div>
                      <div style={{display:'flex',gap:'0.5rem',marginTop:'0.2rem',alignItems:'center'}}>
                        <span className={`badge ${CAT_BADGE[doc.category]||'badge-gray'}`}>{doc.category}</span>
                        <span style={{fontSize:'0.75rem',color:'var(--dim)'}}>{fmtSize(doc.file_size)} Â· {new Date(doc.created_at).toLocaleDateString()}</span>
                      </div>
                    </div>
                  </div>
                  <button className="btn btn-danger btn-sm" onClick={()=>del(doc)}>Delete</button>
                </div>
              ))}
            </div>
          )
        }
      </div>
    </div>
  );
}

// â”€â”€ COLLEGE TRACKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SEED_SCHOOLS = [
  {school_name:'Southern Illinois University Edwardsville (SIUE)',portal_url:'https://www.siue.edu',status:'researching',notes:'Strong psychology program near home'},
  {school_name:'University of Illinois Springfield',portal_url:'https://www.uis.edu',status:'researching',notes:'Good forensic science resources'},
  {school_name:'Missouri Baptist University',portal_url:'https://www.mobap.edu',status:'researching',notes:'Christian university, smaller class sizes'},
  {school_name:'Saint Louis University',portal_url:'https://www.slu.edu',status:'researching',notes:'Strong clinical psych program'},
];

const STATUS_COLORS = {researching:'badge-gray','in-progress':'badge-gold',submitted:'badge-blue',accepted:'badge-green',waitlisted:'badge-teal',rejected:'badge-red'};
const STATUS_LABELS = {researching:'Researching','in-progress':'In Progress',submitted:'Submitted',accepted:'Accepted',waitlisted:'Waitlisted',rejected:'Rejected'};

function TrackerModule({ user, toast }) {
  const [schools, setSchools] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showAdd, setShowAdd] = useState(false);
  const [form, setForm] = useState({school_name:'',deadline:'',portal_url:'',status:'researching',notes:''});

  const load = async () => {
    const sb = getSupabase();
    const { data } = await sb.from('college_applications').select('*').eq('user_id',user.id).order('deadline',{ascending:true,nullsFirst:false});
    if(data&&data.length===0) {
      const seeded = await Promise.all(SEED_SCHOOLS.map(s => sb.from('college_applications').insert({...s,user_id:user.id}).select().single()));
      setSchools(seeded.map(r=>r.data).filter(Boolean));
    } else setSchools(data||[]);
    setLoading(false);
  };
  useEffect(()=>{ load(); },[]);

  const add = async () => {
    if(!form.school_name) return;
    const sb = getSupabase();
    const { error } = await sb.from('college_applications').insert({...form, user_id:user.id});
    if(error) toast('Could not add school','error');
    else { toast('School added!'); setShowAdd(false); setForm({school_name:'',deadline:'',portal_url:'',status:'researching',notes:''}); load(); }
  };

  const updateStatus = async (id, status) => {
    const sb = getSupabase();
    await sb.from('college_applications').update({status}).eq('id',id);
    setSchools(prev=>prev.map(s=>s.id===id?{...s,status}:s));
  };

  return (
    <div>
      <div className="page-header" style={{display:'flex',justifyContent:'space-between',alignItems:'flex-end',flexWrap:'wrap',gap:'1rem'}}>
        <div>
          <div className="page-title serif">College <em style={{color:'var(--gold)'}}>Tracker</em></div>
          <div className="page-sub">Track deadlines, statuses, and requirements</div>
        </div>
        <button className="btn btn-gold" onClick={()=>setShowAdd(true)}>+ Add School</button>
      </div>
      <div className="page-content">
        {loading ? <div className="empty-state"><div className="typing"><span/><span/><span/></div></div> :
          schools.map(s=>{
            const daysLeft = s.deadline ? daysUntil(s.deadline) : null;
            return (
              <div key={s.id} className="card" style={{marginBottom:'1rem',borderLeft:`4px solid ${s.status==='accepted'?'var(--green)':s.status==='rejected'?'var(--red)':'var(--ink)'}`}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',flexWrap:'wrap',gap:'0.5rem'}}>
                  <div>
                    <div className="card-title" style={{fontSize:'1.05rem'}}>{s.school_name}</div>
                    <div style={{display:'flex',gap:'0.5rem',marginTop:'0.4rem',flexWrap:'wrap',alignItems:'center'}}>
                      <span className={`badge ${STATUS_COLORS[s.status]||'badge-gray'}`}>{STATUS_LABELS[s.status]||s.status}</span>
                      {daysLeft!==null && <span style={{fontSize:'0.78rem',color:daysLeft<14?'var(--red)':'var(--dim)',fontFamily:'DM Mono,monospace'}}>{daysLeft>0?`${daysLeft} days remaining`:'Past deadline'}</span>}
                      {s.portal_url && <a href={s.portal_url} target="_blank" rel="noreferrer" style={{fontSize:'0.75rem',color:'var(--gold)'}}>Portal â†’</a>}
                    </div>
                  </div>
                  <select className="select" style={{width:'auto',fontSize:'0.78rem'}} value={s.status} onChange={e=>updateStatus(s.id,e.target.value)}>
                    {Object.entries(STATUS_LABELS).map(([v,l])=><option key={v} value={v}>{l}</option>)}
                  </select>
                </div>
                {s.notes && <div style={{marginTop:'0.6rem',fontSize:'0.83rem',color:'var(--dim)',fontStyle:'italic'}}>{s.notes}</div>}
                <div style={{marginTop:'0.8rem',display:'flex',gap:'0.4rem',flexWrap:'wrap'}}>
                  {['Transcript','Rec Letters','Personal Essay','App Fee','Test Scores'].map(item=>(
                    <span key={item} style={{fontSize:'0.72rem',padding:'0.2rem 0.6rem',border:'1px solid var(--faint)',color:'var(--dim)',fontFamily:'DM Mono,monospace'}}>â˜ {item}</span>
                  ))}
                </div>
              </div>
            );
          })
        }
      </div>

      <Modal open={showAdd} onClose={()=>setShowAdd(false)} title="Add College">
        <div className="mb2"><label className="label">School Name *</label><input className="input" value={form.school_name} onChange={e=>setForm(p=>({...p,school_name:e.target.value}))} placeholder="University name"/></div>
        <div className="mb2"><label className="label">Application Deadline</label><input className="input" type="date" value={form.deadline} onChange={e=>setForm(p=>({...p,deadline:e.target.value}))}/></div>
        <div className="mb2"><label className="label">Portal URL</label><input className="input" value={form.portal_url} onChange={e=>setForm(p=>({...p,portal_url:e.target.value}))} placeholder="https://..."/></div>
        <div className="mb2"><label className="label">Notes</label><textarea className="input" value={form.notes} onChange={e=>setForm(p=>({...p,notes:e.target.value}))} placeholder="Any notes about this school..."/></div>
        <button className="btn btn-gold" onClick={add}>Add School</button>
      </Modal>
    </div>
  );
}

// â”€â”€ ACHIEVEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SEED_ACHIEVEMENTS = [
  {title:'Patient Enrichment Program',category:'volunteer',role:'Founder & Program Director',description:'Self-designed annual program collecting enrichment items (games, puzzles, books, art supplies) for hospital patients experiencing mental health crises or cognitive decline. Unaffiliated with any hospital â€” community-funded and personally championed. Extended from August to September due to community response. Now an ongoing annual program.',impact:'Ongoing annual program serving multiple local hospitals'},
  {title:'Mu Alpha Theta',category:'organization',role:'Member',description:'National mathematics honor society for high school students. Membership reflects demonstrated excellence in mathematics coursework and academic achievement.',impact:'National academic recognition in mathematics'},
  {title:'Link Crew',category:'organization',role:'Peer Mentor',description:'Selected and trained peer mentorship program. Link Crew members guide incoming freshmen through the high school transition â€” providing orientation, support, and connection throughout their first year.',impact:'Direct mentorship for incoming students'},
  {title:'Salvation Army Meal Service',category:'volunteer',role:'Volunteer',description:'Regular volunteer service preparing and serving meals to community members in need at the Salvation Army. Consistent direct community engagement.',impact:'Consistent direct community service'},
  {title:'Church Nursery',category:'volunteer',role:'Volunteer Caregiver',description:'Consistent volunteer childcare and engagement service in faith community nursery. Reliable presence providing care and support.',impact:'Reliable caregiving for faith community'},
  {title:'Mathematics Tutoring',category:'volunteer',role:'Peer Tutor',description:'Volunteer mathematics tutoring for students needing additional academic support. Translating complex concepts into accessible explanations with patience.',impact:'Peer academic support in mathematics'},
];
const ACH_BADGE = {volunteer:'badge-green',organization:'badge-blue',internship:'badge-purple',award:'badge-gold',other:'badge-gray'};

function AchievementsModule({ user, toast, coachUrl }) {
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showAdd, setShowAdd] = useState(false);
  const [genResult, setGenResult] = useState('');
  const [genLoading, setGenLoading] = useState(false);
  const [form, setForm] = useState({title:'',category:'volunteer',role:'',description:'',impact:''});

  const load = async () => {
    const sb = getSupabase();
    const { data } = await sb.from('achievements').select('*').eq('user_id',user.id).order('created_at');
    if(data&&data.length===0) {
      await Promise.all(SEED_ACHIEVEMENTS.map(a=>sb.from('achievements').insert({...a,user_id:user.id})));
      const { data:d2 } = await sb.from('achievements').select('*').eq('user_id',user.id).order('created_at');
      setItems(d2||[]);
    } else setItems(data||[]);
    setLoading(false);
  };
  useEffect(()=>{ load(); },[]);

  const add = async () => {
    if(!form.title) return;
    const sb = getSupabase();
    await sb.from('achievements').insert({...form, user_id:user.id});
    toast('Achievement added!'); setShowAdd(false); setForm({title:'',category:'volunteer',role:'',description:'',impact:''});
    load();
  };

  const del = async (id) => {
    if(!window.confirm('Delete this achievement?')) return;
    const sb = getSupabase();
    await sb.from('achievements').delete().eq('id',id);
    toast('Deleted','success'); load();
  };

  const generate = async () => {
    if(!coachUrl) { toast('Coach URL not configured. Add it in setup.','warn'); return; }
    setGenLoading(true);
    const achText = items.map(a=>`${a.title} | ${a.role} | ${a.description}`).join('\n');
    try {
      const res = await fetch(coachUrl, {
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+getAnonKey()},
        body: JSON.stringify({
          messages:[{role:'user',content:`Format Sloan's activities for the Common App Activities section. Max 10 activities, 150 characters each for description, include position/role and organization. Here are her activities:\n\n${achText}\n\nFormat each as:\nACTIVITY [#]: [Title]\nPosition: [Role]\nOrganization: [Org name]\nDescription (150 chars max): [description]\n\nCount characters carefully.`}],
          vaultContext: achText
        })
      });
      const data = await res.json();
      const text = data.content?.[0]?.text || 'No response from Coach.';
      setGenResult(text);
    } catch(e) { toast('Coach connection failed','error'); }
    setGenLoading(false);
  };

  return (
    <div>
      <div className="page-header" style={{display:'flex',justifyContent:'space-between',alignItems:'flex-end',flexWrap:'wrap',gap:'1rem'}}>
        <div>
          <div className="page-title serif"><em style={{color:'var(--gold)'}}>Achievements</em> Log</div>
          <div className="page-sub">Your extracurriculars, service, and leadership</div>
        </div>
        <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap'}}>
          <button className="btn btn-outline btn-sm" onClick={generate} disabled={genLoading}>{genLoading?'Generating...':'ğŸ¤– Generate Common App Activities'}</button>
          <button className="btn btn-gold btn-sm" onClick={()=>setShowAdd(true)}>+ Add Achievement</button>
        </div>
      </div>
      <div className="page-content">
        {genResult && (
          <div style={{background:'var(--ink)',color:'#e0d8d0',padding:'1.5rem',marginBottom:'1.5rem'}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.8rem'}}>
              <div className="mono" style={{fontSize:'0.6rem',letterSpacing:'0.15em',textTransform:'uppercase',color:'var(--gold)'}}>Common App Activities â€” Coach Output</div>
              <button className="btn btn-gold btn-sm" onClick={()=>{navigator.clipboard.writeText(genResult);toast('Copied!','success');}}>Copy All</button>
            </div>
            <pre style={{whiteSpace:'pre-wrap',fontFamily:'DM Mono,monospace',fontSize:'0.78rem',lineHeight:1.7}}>{genResult}</pre>
          </div>
        )}

        {loading ? <div className="empty-state"><div className="typing"><span/><span/><span/></div></div> :
          items.map(a=>(
            <div key={a.id} className="card" style={{marginBottom:'1rem',borderTop:'3px solid var(--ink)'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
                <div style={{flex:1}}>
                  <div style={{display:'flex',gap:'0.5rem',alignItems:'center',flexWrap:'wrap',marginBottom:'0.3rem'}}>
                    <span className={`badge ${ACH_BADGE[a.category]||'badge-gray'}`}>{a.category}</span>
                    {a.role && <span style={{fontFamily:'DM Mono,monospace',fontSize:'0.58rem',letterSpacing:'0.1em',textTransform:'uppercase',color:'var(--gold)'}}>{a.role}</span>}
                  </div>
                  <div className="card-title">{a.title}</div>
                  <p style={{fontSize:'0.85rem',color:'#3a3020',marginTop:'0.4rem',lineHeight:1.65}}>{a.description}</p>
                  {a.impact && <div style={{fontSize:'0.82rem',color:'var(--dim)',fontStyle:'italic',marginTop:'0.4rem'}}>Impact: {a.impact}</div>}
                </div>
                <button className="btn btn-danger btn-sm" style={{marginLeft:'1rem',flexShrink:0}} onClick={()=>del(a.id)}>Delete</button>
              </div>
            </div>
          ))
        }
      </div>

      <Modal open={showAdd} onClose={()=>setShowAdd(false)} title="Add Achievement">
        <div className="mb2"><label className="label">Title *</label><input className="input" value={form.title} onChange={e=>setForm(p=>({...p,title:e.target.value}))} placeholder="Name of organization, award, or activity"/></div>
        <div className="mb2"><label className="label">Category</label>
          <select className="select" value={form.category} onChange={e=>setForm(p=>({...p,category:e.target.value}))}>
            {['volunteer','organization','internship','award','other'].map(c=><option key={c}>{c}</option>)}
          </select>
        </div>
        <div className="mb2"><label className="label">Your Role / Position</label><input className="input" value={form.role} onChange={e=>setForm(p=>({...p,role:e.target.value}))} placeholder="President, Volunteer, Member..."/></div>
        <div className="mb2"><label className="label">Description</label><textarea className="input" value={form.description} onChange={e=>setForm(p=>({...p,description:e.target.value}))} placeholder="What did you do? What did it involve?"/></div>
        <div className="mb2"><label className="label">One-Line Impact</label><input className="input" value={form.impact} onChange={e=>setForm(p=>({...p,impact:e.target.value}))} placeholder="What did your involvement accomplish?"/></div>
        <button className="btn btn-gold" onClick={add}>Save Achievement</button>
      </Modal>
    </div>
  );
}

// â”€â”€ FINANCIAL AID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SCHOLARSHIPS_SEED = [
  {name:'Illinois MAP Grant',amount_min:0,amount_max:5968,status:'researching',url:'https://www.isac.org',requirements:'Illinois resident, financial need, FAFSA required by state deadline'},
  {name:'APA Psychology Undergraduate Scholarship',amount_min:1000,amount_max:1000,status:'researching',url:'https://www.apa.org',requirements:'Psychology major, sophomore+ standing (apply after starting college)'},
  {name:'American Psychology-Law Society',amount_min:500,amount_max:2000,status:'researching',url:'https://www.apadivisions.org/division-41',requirements:'Interest in forensic psychology / psychology and law'},
  {name:'Jack Kent Cooke Foundation',amount_min:0,amount_max:55000,status:'researching',url:'https://www.jkcf.org',requirements:'High-achieving students with financial need'},
  {name:'Alton Community Foundation',amount_min:500,amount_max:5000,status:'researching',url:'https://www.altoncommunityfoundation.org',requirements:'Alton/Madison County IL resident'},
  {name:'Phi Kappa Phi Scholarship',amount_min:0,amount_max:8500,status:'researching',url:'https://www.phikappaphi.org',requirements:'First-year college student, chapter sponsorship'},
  {name:'Women in STEM Scholarships',amount_min:500,amount_max:5000,status:'researching',url:'https://www.fastweb.com',requirements:'Female student in STEM or social science'},
];
const FAFSA_SECTIONS = [
  {title:'Before You Start â€” What to Gather',content:<ul><li>Prior year tax returns for parents AND student</li><li>W-2 forms</li><li>Bank account balances for parents and student</li><li>Investment account balances</li><li>Social Security numbers for student and parents</li><li>FSA ID â€” create at <strong>studentaid.gov</strong> (this IS your signature, do it early)</li><li>Sloan's Alton High School student ID number</li><li>List of schools to add to FAFSA</li></ul>},
  {title:'Key FAFSA Facts',content:<ul><li>FAFSA opens <strong>October 1</strong> each year for the following academic year</li><li>Illinois priority deadline: typically <strong>late January</strong> â€” check isac.org each year</li><li>The new <strong>Student Aid Index (SAI)</strong> replaced EFC starting 2024-2025</li><li>Lower SAI = more aid eligible</li><li>Most schools use FAFSA for ALL financial aid including institutional scholarships</li><li>FAFSA is FREE â€” never pay to file it</li></ul>},
  {title:'What Counts as Assets (and What Doesn\'t)',content:<ul><li>Parent assets counted at max <strong>5.64%</strong> toward SAI â€” low impact</li><li>Student assets counted at <strong>20%</strong> â€” higher impact, keep student balances low</li><li>Parent-owned <strong>529 plan: only 5.64% counts</strong> toward SAI â€” very favorable</li><li><strong>Primary home equity: does NOT count</strong> on FAFSA</li><li><strong>Retirement accounts: do NOT count</strong> on FAFSA</li><li>Small businesses (under 100 employees) owned by parents may be excluded</li></ul>},
  {title:'Illinois-Specific Aid',content:<ul><li><strong>MAP Grant</strong> (Monetary Award Program): up to $5,968/year for IL residents with financial need</li><li>Requires FAFSA completion by the Illinois state deadline â€” check isac.org for current year</li><li>MAP Grant applies to eligible Illinois colleges â€” SIUE, UIS, and SLU all have MAP-eligible programs</li><li>Award is renewable each year if you re-file FAFSA and maintain academic progress</li></ul>},
  {title:'Understanding Your Award Letter',content:<ul><li>Schools send award letters after you apply â€” may arrive at different times</li><li>Award letters may mix <strong>grants (free money)</strong>, <strong>loans (pay back)</strong>, and work-study</li><li><strong>Net price = total cost minus GRANTS ONLY</strong> â€” do not include loans in your calculation</li><li>Compare net prices across schools, not sticker prices</li><li>Contact financial aid offices to negotiate â€” it is allowed and common</li></ul>},
];

function FinancialModule({ user, toast, coachUrl }) {
  const [tab, setTab] = useState('fafsa');
  const [openSection, setOpenSection] = useState(null);
  const [scholarships, setScholarships] = useState([]);
  const [balance529, setBalance529] = useState('');
  const [targetCost, setTargetCost] = useState('');

  const loadScholarships = async () => {
    const sb = getSupabase();
    const { data } = await sb.from('scholarships').select('*').eq('user_id',user.id);
    if(data&&data.length===0) {
      await Promise.all(SCHOLARSHIPS_SEED.map(s=>sb.from('scholarships').insert({...s,user_id:user.id})));
      const { data:d2 } = await sb.from('scholarships').select('*').eq('user_id',user.id);
      setScholarships(d2||[]);
    } else setScholarships(data||[]);
  };
  useEffect(()=>{ if(tab==='scholarships') loadScholarships(); },[tab]);

  const updateScholarshipStatus = async (id, status) => {
    const sb = getSupabase();
    await sb.from('scholarships').update({status}).eq('id',id);
    setScholarships(prev=>prev.map(s=>s.id===id?{...s,status}:s));
  };

  const totalPotential = scholarships.filter(s=>s.status==='submitted'||s.status==='awarded').reduce((a,s)=>a+(s.amount_max||0),0);

  const calc529 = () => {
    const bal = parseFloat(balance529)||0;
    const annual = parseFloat(targetCost)||0;
    const years = 2026 - new Date().getFullYear();
    const projected = bal * Math.pow(1.06, years);
    const total4yr = annual * 4;
    const pct = total4yr > 0 ? Math.min(100,(projected/total4yr)*100).toFixed(0) : 0;
    return { projected: projected.toFixed(0), total4yr: total4yr.toFixed(0), pct };
  };

  return (
    <div>
      <div className="page-header">
        <div className="page-title serif">Financial <em style={{color:'var(--gold)'}}>Aid Hub</em></div>
        <div className="page-sub">FAFSA guide Â· 529 tracker Â· Scholarship database</div>
      </div>
      <div className="page-content">
        <div className="tabs">
          {[['fafsa','ğŸ“‹ FAFSA Guide'],['529','ğŸ’° 529 Tracker'],['scholarships','ğŸ† Scholarships']].map(([id,label])=>(
            <div key={id} className={`tab${tab===id?' active':''}`} onClick={()=>setTab(id)}>{label}</div>
          ))}
        </div>

        {tab==='fafsa' && (
          <div>
            <div className="info-box" style={{marginBottom:'1.5rem'}}>
              <strong>Illinois Priority Deadline</strong>
              File your FAFSA as early as possible after October 1. Illinois MAP Grant funding is limited â€” file early to maximize your award. Check <strong>isac.org</strong> for the exact current year deadline.
            </div>
            {FAFSA_SECTIONS.map((s,i)=>(
              <div key={i} className="accordion-item">
                <div className="accordion-header" onClick={()=>setOpenSection(openSection===i?null:i)}>
                  {s.title}
                  <span>{openSection===i?'â–²':'â–¼'}</span>
                </div>
                {openSection===i && <div className="accordion-body">{s.content}</div>}
              </div>
            ))}
          </div>
        )}

        {tab==='529' && (
          <div>
            <div className="info-box">
              <strong>Illinois Bright Start 529 Plan Key Facts</strong>
              State tax deduction: $10,000/yr (single) or $20,000/yr (joint filers) Â· Earnings grow tax-FREE Â· Qualified withdrawals 100% tax-free federally Â· FAFSA impact: only 5.64% counts toward SAI Â· SECURE 2.0: unused funds can roll to Roth IRA (up to $35k lifetime, account must be 15+ years old) Â· <a href="https://www.brightstartsavings.com" target="_blank" rel="noreferrer" style={{color:'var(--gold)'}}>brightstartsavings.com â†’</a>
            </div>
            <div className="grid2">
              <div>
                <label className="label">Current 529 Balance ($)</label>
                <input className="input mb2" type="number" value={balance529} onChange={e=>setBalance529(e.target.value)} placeholder="25000"/>
                <label className="label">Target School Annual Cost ($)</label>
                <input className="input" type="number" value={targetCost} onChange={e=>setTargetCost(e.target.value)} placeholder="30000"/>
              </div>
              <div className="card">
                <div className="card-label">529 Coverage Projection</div>
                {balance529 && targetCost ? (() => {
                  const {projected,total4yr,pct} = calc529();
                  return <>
                    <div style={{fontSize:'2rem',fontFamily:'Playfair Display,serif',fontWeight:900,color:'var(--gold)'}}>{pct}%</div>
                    <div style={{fontSize:'0.82rem',color:'var(--dim)',marginBottom:'0.8rem'}}>of projected 4-year costs covered</div>
                    <div className="progress-bar mb2"><div className="progress-fill" style={{width:pct+'%'}}/></div>
                    <div style={{fontSize:'0.8rem',lineHeight:1.8}}>
                      <div>Projected balance at enrollment: <strong>${parseInt(projected).toLocaleString()}</strong></div>
                      <div>4-year total cost: <strong>${parseInt(total4yr).toLocaleString()}</strong></div>
                      <div>Gap: <strong>${Math.max(0,parseInt(total4yr)-parseInt(projected)).toLocaleString()}</strong></div>
                    </div>
                  </>;
                })() : <div style={{color:'var(--dim)',fontSize:'0.85rem'}}>Enter your balance and target school cost to see projection</div>}
              </div>
            </div>
          </div>
        )}

        {tab==='scholarships' && (
          <div>
            {totalPotential > 0 && (
              <div className="card" style={{borderTop:'3px solid var(--green)',marginBottom:'1.5rem'}}>
                <div className="card-label" style={{color:'var(--green)'}}>Potential Aid Submitted</div>
                <div style={{fontSize:'2rem',fontFamily:'Playfair Display,serif',fontWeight:900,color:'var(--green)'}}>${totalPotential.toLocaleString()}</div>
                <div style={{fontSize:'0.8rem',color:'var(--dim)'}}>maximum from submitted applications</div>
              </div>
            )}
            {scholarships.map(s=>(
              <div key={s.id} className="card" style={{marginBottom:'1rem'}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',flexWrap:'wrap',gap:'0.5rem'}}>
                  <div>
                    <div className="card-title">{s.name}</div>
                    <div style={{display:'flex',gap:'0.5rem',marginTop:'0.3rem',alignItems:'center',flexWrap:'wrap'}}>
                      <span className={`badge ${STATUS_COLORS[s.status]||'badge-gray'}`}>{s.status}</span>
                      <span style={{fontSize:'0.8rem',color:'var(--green)',fontWeight:600}}>{s.amount_max?`Up to $${s.amount_max.toLocaleString()}`:''}</span>
                      {s.url && <a href={s.url} target="_blank" rel="noreferrer" style={{fontSize:'0.75rem',color:'var(--gold)'}}>Info â†’</a>}
                    </div>
                    {s.requirements && <div style={{fontSize:'0.8rem',color:'var(--dim)',marginTop:'0.4rem'}}>{s.requirements}</div>}
                  </div>
                  <select className="select" style={{width:'auto',fontSize:'0.78rem'}} value={s.status} onChange={e=>updateScholarshipStatus(s.id,e.target.value)}>
                    {['researching','drafting','submitted','awarded','not-selected'].map(v=><option key={v}>{v}</option>)}
                  </select>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

// â”€â”€ COACH MODULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ PROFILE BUILDER MODULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ProfileModule({ user, toast }) {
  const [form, setForm] = useState({
    full_name:'Sloan Smith',
    tagline:'Aspiring Forensic Psychologist & Community Builder',
    bio:"I'm a senior at Alton High School with a passion for understanding the human mind and a clear mission: to earn my PhD in Forensic Psychology and apply science in service of justice and healing. Outside the classroom, I'm building things â€” programs, communities, and a body of work that reflects who I am and where I'm going.",
    school:'Alton High School',
    grad_year:'Class of 2026',
    email:'sloan@sloanmelia.com',
    linkedin_url:'',
    share_enabled:true,
    share_slug:'sloan-smith'
  });
  const [loading, setLoading]   = useState(true);
  const [saving, setSaving]     = useState(false);
  const [tab, setTab]           = useState('edit'); // edit | share
  const [copied, setCopied]     = useState('');
  const [liveGpa, setLiveGpa]   = useState(null);
  const PUBLIC_URL = 'https://sloanmelia.com/index.html';

  // Load existing profile + live GPA
  useEffect(()=>{
    const sb = getSupabase();
    Promise.all([
      sb.from('profile').select('*').eq('user_id', user.id).single(),
      sb.from('grades').select('grade_points,credit_hours').eq('user_id', user.id)
    ]).then(([{data:p}, {data:g}])=>{
      if(p) setForm(f=>({...f,...p}));
      const gpa = calcGPA(g||[]);
      if(gpa) setLiveGpa(gpa);
      setLoading(false);
    }).catch(()=>setLoading(false));
  },[user]);

  const save = async () => {
    setSaving(true);
    const sb = getSupabase();
    const {error} = await sb.from('profile').upsert({
      ...form,
      user_id: user.id,
      updated_at: new Date().toISOString()
    }, {onConflict:'user_id'});
    if(error){ toast('Save error: '+error.message); setSaving(false); return; }
    toast('âœ… Profile saved! Public page will reflect your changes.');
    setSaving(false);
  };

  const copy = (text, key) => {
    navigator.clipboard.writeText(text);
    setCopied(key);
    setTimeout(()=>setCopied(''), 2500);
  };

  const shareUrl   = PUBLIC_URL;
  const shareText  = `Check out my college profile: ${shareUrl}`;
  const emailHref  = `mailto:?subject=Sloan Smith â€” College Profile&body=Hi! I wanted to share my college application profile with you: ${shareUrl}`;
  const smsHref    = `sms:?body=${encodeURIComponent(shareText)}`;

  if(loading) return <div style={{padding:'2rem',color:'var(--dim)'}}>Loading profile...</div>;

  return (
    <div>
      <div className="page-header">
        <div className="page-title serif">Profile <em style={{color:'var(--gold)'}}>Builder</em></div>
        <div className="page-sub">Edit your public profile Â· Generate a shareable link for colleges and internships</div>
      </div>
      <div className="page-content">

        {/* Preview strip */}
        <div style={{
          background:'var(--ink)',color:'var(--cream)',
          borderRadius:'10px',padding:'1rem 1.4rem',
          display:'flex',alignItems:'center',justifyContent:'space-between',
          marginBottom:'1.5rem',flexWrap:'wrap',gap:'0.8rem'
        }}>
          <div>
            <div style={{fontFamily:'serif',fontSize:'1.1rem',fontWeight:700}}>{form.full_name}</div>
            <div style={{fontSize:'0.78rem',opacity:0.6,fontStyle:'italic'}}>{form.tagline}</div>
            <div style={{fontSize:'0.72rem',opacity:0.45,marginTop:'0.2rem',fontFamily:'monospace'}}>{PUBLIC_URL}</div>
          </div>
          <a href={PUBLIC_URL} target="_blank" rel="noopener noreferrer"
            className="btn btn-gold" style={{textDecoration:'none',flexShrink:0}}>
            ğŸŒ Preview Live Profile â†—
          </a>
        </div>

        {/* Tabs */}
        <div style={{display:'flex',gap:'0.5rem',marginBottom:'1.2rem'}}>
          {[['edit','âœï¸ Edit Profile'],['share','ğŸ“¤ Share & Send']].map(([t,lbl])=>(
            <button key={t} onClick={()=>setTab(t)} className="btn btn-sm"
              style={{
                background:tab===t?'var(--ink)':'transparent',
                color:tab===t?'var(--cream)':'var(--dim)',
                border:'1px solid var(--border)',fontSize:'0.8rem'
              }}>{lbl}</button>
          ))}
        </div>

        {/* â”€â”€ EDIT TAB â”€â”€ */}
        {tab==='edit' && (
          <div style={{display:'grid',gap:'1rem'}}>

            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.8rem'}}>
              <div>
                <label className="label">Full Name</label>
                <input className="input" value={form.full_name} onChange={e=>setForm(p=>({...p,full_name:e.target.value}))}/>
              </div>
              <div>
                <label className="label">School</label>
                <input className="input" value={form.school} onChange={e=>setForm(p=>({...p,school:e.target.value}))}/>
              </div>
            </div>

            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.8rem'}}>
              <div>
                <label className="label">Graduating Class</label>
                <input className="input" value={form.grad_year} onChange={e=>setForm(p=>({...p,grad_year:e.target.value}))}/>
              </div>
              <div>
                <label className="label">
                  GPA Shown on Profile
                  {liveGpa && <span style={{color:'#059669',marginLeft:'0.4rem',fontWeight:700}}>(Live: {liveGpa.toFixed(3)})</span>}
                </label>
                <input className="input" value={liveGpa ? liveGpa.toFixed(3) : '3.84'} readOnly
                  style={{background:'#f0fdf4',color:'#059669',fontWeight:700}}/>
              </div>
            </div>

            <div>
              <label className="label">Tagline <span style={{color:'var(--dim)',fontWeight:400}}>(shown under your name)</span></label>
              <input className="input" value={form.tagline} onChange={e=>setForm(p=>({...p,tagline:e.target.value}))}
                placeholder="Aspiring Forensic Psychologist & Community Builder"/>
            </div>

            <div>
              <label className="label">Bio <span style={{color:'var(--dim)',fontWeight:400}}>(hero paragraph â€” 2â€“4 sentences)</span></label>
              <textarea className="input" rows={4} style={{resize:'vertical'}}
                value={form.bio} onChange={e=>setForm(p=>({...p,bio:e.target.value}))}/>
            </div>

            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.8rem'}}>
              <div>
                <label className="label">Contact Email</label>
                <input className="input" type="email" value={form.email} onChange={e=>setForm(p=>({...p,email:e.target.value}))}/>
              </div>
              <div>
                <label className="label">LinkedIn URL <span style={{color:'var(--dim)',fontWeight:400}}>(optional)</span></label>
                <input className="input" value={form.linkedin_url||''} onChange={e=>setForm(p=>({...p,linkedin_url:e.target.value}))}
                  placeholder="https://linkedin.com/in/sloan-smith"/>
              </div>
            </div>

            <div className="card" style={{borderTop:'3px solid #059669',padding:'1rem'}}>
              <label style={{display:'flex',alignItems:'center',gap:'0.8rem',cursor:'pointer'}}>
                <input type="checkbox" checked={form.share_enabled}
                  onChange={e=>setForm(p=>({...p,share_enabled:e.target.checked}))}
                  style={{width:'16px',height:'16px'}}/>
                <div>
                  <div style={{fontWeight:700,fontSize:'0.9rem'}}>Public Profile Active</div>
                  <div style={{fontSize:'0.8rem',color:'var(--dim)'}}>When on, anyone with the link can view your profile. Turn off to make it private.</div>
                </div>
              </label>
            </div>

            <button className="btn btn-gold" style={{width:'100%',padding:'0.8rem'}} onClick={save} disabled={saving}>
              {saving ? 'Saving...' : 'ğŸ’¾ Save Profile Changes'}
            </button>
          </div>
        )}

        {/* â”€â”€ SHARE TAB â”€â”€ */}
        {tab==='share' && (
          <div style={{display:'grid',gap:'1rem'}}>

            <div className="info-box">
              <strong>Your profile link</strong> â€” share this with colleges, scholarship committees, admissions officers, or internship opportunities.
            </div>

            {/* The link */}
            <div className="card" style={{borderTop:'4px solid var(--gold)',padding:'1.2rem'}}>
              <div className="label" style={{marginBottom:'0.5rem'}}>Your Public Profile URL</div>
              <div style={{display:'flex',gap:'0.6rem',alignItems:'center'}}>
                <div style={{
                  flex:1,background:'var(--cream)',border:'1px solid var(--border)',
                  borderRadius:'6px',padding:'0.7rem 1rem',
                  fontFamily:'monospace',fontSize:'0.9rem',color:'var(--ink)',
                  wordBreak:'break-all'
                }}>{PUBLIC_URL}</div>
                <button className="btn btn-gold" style={{flexShrink:0,whiteSpace:'nowrap'}}
                  onClick={()=>copy(PUBLIC_URL,'url')}>
                  {copied==='url' ? 'âœ“ Copied!' : 'ğŸ“‹ Copy Link'}
                </button>
              </div>
            </div>

            {/* Send options */}
            <div className="section-label">Send It</div>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.8rem'}}>

              {/* Email */}
              <a href={emailHref}
                style={{textDecoration:'none'}}
                className="card"
                onClick={()=>toast('Opening email...')}
              >
                <div style={{fontSize:'2rem',marginBottom:'0.5rem'}}>âœ‰ï¸</div>
                <div style={{fontWeight:700,fontSize:'0.95rem',marginBottom:'0.2rem'}}>Send via Email</div>
                <div style={{fontSize:'0.8rem',color:'var(--dim)'}}>Opens your mail app with the link pre-loaded. Great for college admissions offices.</div>
                <div style={{marginTop:'0.8rem',fontSize:'0.78rem',color:'var(--gold)',fontWeight:600}}>Tap to open mail app â†’</div>
              </a>

              {/* Text */}
              <a href={smsHref}
                style={{textDecoration:'none'}}
                className="card"
                onClick={()=>toast('Opening messages...')}
              >
                <div style={{fontSize:'2rem',marginBottom:'0.5rem'}}>ğŸ’¬</div>
                <div style={{fontWeight:700,fontSize:'0.95rem',marginBottom:'0.2rem'}}>Send via Text</div>
                <div style={{fontSize:'0.8rem',color:'var(--dim)'}}>Opens your messages app with the link ready to send. Great for sharing with family or advisors.</div>
                <div style={{marginTop:'0.8rem',fontSize:'0.78rem',color:'var(--gold)',fontWeight:600}}>Tap to open messages â†’</div>
              </a>
            </div>

            {/* Copy full message */}
            <div className="card" style={{padding:'1.2rem'}}>
              <div className="label" style={{marginBottom:'0.6rem'}}>Copy Full Message</div>
              <div style={{
                background:'var(--cream)',borderRadius:'6px',padding:'1rem',
                fontSize:'0.88rem',lineHeight:1.7,color:'var(--ink)',
                border:'1px solid var(--border)',marginBottom:'0.8rem',
                fontStyle:'italic'
              }}>
                "Hi, I wanted to share my college application profile with you. You can view my academic record, activities, and career goals here: {PUBLIC_URL} â€” Sloan Smith, Alton High School Class of 2026"
              </div>
              <button className="btn btn-sm" style={{background:'var(--ink)',color:'var(--cream)',border:'none'}}
                onClick={()=>copy(`Hi, I wanted to share my college application profile with you. You can view my academic record, activities, and career goals here: ${PUBLIC_URL} â€” Sloan Smith, Alton High School Class of 2026`,'msg')}>
                {copied==='msg' ? 'âœ“ Copied!' : 'ğŸ“‹ Copy Full Message'}
              </button>
            </div>

            {/* QR note */}
            <div style={{textAlign:'center',padding:'1rem',color:'var(--dim)',fontSize:'0.82rem',borderTop:'1px solid var(--border)'}}>
              ğŸ’¡ Tip: You can also screenshot this URL or add it to your college applications, LinkedIn, or email signature.
            </div>
          </div>
        )}

      </div>
    </div>
  );
}

// â”€â”€ GPA MODULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SEMESTERS = ['Fall 2022','Spring 2023','Fall 2023','Spring 2024','Fall 2024','Spring 2025','Fall 2025','Spring 2026'];

function GpaModule({ user, toast }) {
  const [grades, setGrades] = useState([]);
  const [loading, setLoading] = useState(true);
  const [form, setForm] = useState({course_name:'',grade_letter:'A',credit_hours:1,semester:'Fall 2025',is_ap:false,is_honors:false});
  const [saving, setSaving] = useState(false);
  const [pasteText, setPasteText] = useState('');
  const [parsing, setParsing] = useState(false);
  const [tab, setTab] = useState('view'); // 'view','add','parse'
  const [vaultDocs, setVaultDocs] = useState([]);
  const [selectedDocs, setSelectedDocs] = useState([]);
  const [parseMode, setParseMode] = useState('vault'); // 'vault' | 'paste'
  const coachUrl = localStorage.getItem('sm_coach')||'';
  const anonKey = localStorage.getItem('sm_key')||'';
  const SUPA_URL = 'https://gpktuflimoqeyxtwadsy.supabase.co';

  const load = async () => {
    setLoading(true);
    const sb = getSupabase();
    const {data} = await sb.from('grades').select('*').eq('user_id',user.id).order('grade_year',{ascending:true}).order('semester',{ascending:true});
    setGrades(data||[]);
    setLoading(false);
  };

  useEffect(()=>{
    load();
    // Load transcript docs from vault
    const sb = getSupabase();
    sb.from('documents').select('id,name,category,file_path')
      .eq('user_id', user.id)
      .in('category', ['Transcript','Test Scores'])
      .order('created_at', {ascending:false})
      .then(({data}) => setVaultDocs(data||[]));
  },[user]);

  const gpaUnweighted = calcGPA(grades);
  const gpaWeighted   = calcWeightedGPA(grades);
  const gpaCore       = calcCoreGPA(grades);
  const gpa           = gpaUnweighted; // keep for term calcs (always unweighted per term)
  const byTerm = grades.reduce((acc,g)=>{
    const k = g.semester||'Unknown';
    if(!acc[k]) acc[k]=[];
    acc[k].push(g);
    return acc;
  },{});

  const addGrade = async () => {
    if(!form.course_name.trim()) { toast('Enter a course name'); return; }
    setSaving(true);
    const pts = gradeToPoints(form.grade_letter);
    const sb = getSupabase();
    const {error} = await sb.from('grades').insert({
      user_id: user.id,
      course_name: form.course_name.trim(),
      grade_letter: form.grade_letter,
      grade_points: pts,
      credit_hours: parseFloat(form.credit_hours),
      semester: form.semester,
      grade_year: parseInt(form.semester.split(' ')[1]||'2025'),
      is_ap: form.is_ap,
      is_honors: form.is_honors,
      source: 'manual'
    });
    if(error) { toast('Error saving: ' + error.message); setSaving(false); return; }
    toast('Course added!');
    setForm({course_name:'',grade_letter:'A',credit_hours:1,semester:'Fall 2025',is_ap:false,is_honors:false});
    setSaving(false);
    await load();
  };

  const deleteGrade = async (id) => {
    const sb = getSupabase();
    await sb.from('grades').delete().eq('id',id);
    await load();
    toast('Removed');
  };

  // â”€â”€ Helper: save parsed rows to DB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const saveParsedRows = async (parsed) => {
    if(!Array.isArray(parsed) || parsed.length === 0) {
      toast('No courses found â€” check the transcript and try again');
      return false;
    }
    const sb = getSupabase();
    const rows = parsed.map(r=>({
      user_id: user.id,
      course_name: r.course_name,
      grade_letter: r.grade_letter,
      grade_points: gradeToPoints(r.grade_letter),
      credit_hours: parseFloat(r.credit_hours)||1,
      semester: r.semester||'Unknown',
      grade_year: parseInt((r.semester||'2025').split(' ').pop())||2025,
      is_ap: !!r.is_ap,
      is_honors: !!r.is_honors,
      source: 'parsed'
    }));
    const {error} = await sb.from('grades').insert(rows);
    if(error) { toast('Save error: '+error.message); return false; }
    toast(`âœ… Imported ${rows.length} courses! GPA updated.`);
    setTab('view');
    await load();
    return true;
  };

  const PARSE_PROMPT = `You are reading a high school transcript. Extract every course and return ONLY a valid JSON array with no explanation.
Each item must have exactly these fields:
- course_name (string)
- grade_letter (A, A-, B+, B, B-, C+, C, C-, D, F â€” exactly as shown)
- credit_hours (number, use 1.0 if not shown)
- semester ("Fall 2022", "Spring 2023", "Fall 2023", "Spring 2024", "Fall 2024", "Spring 2025", "Fall 2025", or "Spring 2026")
- is_ap (true if course name contains AP, false otherwise)
- is_honors (true if course name contains H, Honors, or CP, false otherwise)
Include ALL courses from ALL years shown. Return ONLY the JSON array.`;

  // â”€â”€ Parse from vault images â€” one image at a time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const parseFromVault = async () => {
    if(selectedDocs.length === 0) { toast('Select at least one transcript from your vault'); return; }
    if(!coachUrl) { toast('Coach URL not configured'); return; }
    setParsing(true);
    const allRows = [];
    const sb = getSupabase();

    for(let i = 0; i < selectedDocs.length; i++) {
      const docId = selectedDocs[i];
      const doc = vaultDocs.find(d=>d.id===docId);
      if(!doc) continue;

      toast(`Reading image ${i+1} of ${selectedDocs.length}: ${doc.name}...`);

      try {
        // Get signed URL for this image
        const {data: signedData} = await sb.storage.from('documents').createSignedUrl(doc.file_path, 300);
        if(!signedData?.signedUrl) { console.warn('No signed URL for', doc.name); continue; }

        // Convert to base64
        const imgRes = await fetch(signedData.signedUrl);
        const blob = await imgRes.blob();
        const b64 = await new Promise(res=>{
          const r = new FileReader();
          r.onload = ()=>res(r.result.split(',')[1]);
          r.readAsDataURL(blob);
        });
        const mediaType = blob.type || 'image/jpeg';

        // Send ONE image per call â€” embed instructions directly in user message
        // (no mode param needed â€” instructions are self-contained)
        const res = await fetch(coachUrl, {
          method:'POST',
          headers:{'Content-Type':'application/json','Authorization':'Bearer '+anonKey},
          body: JSON.stringify({
            messages:[{
              role:'user',
              content:[
                {type:'image', source:{type:'base64', media_type:mediaType, data:b64}},
                {type:'text', text: PARSE_PROMPT}
              ]
            }]
          })
        });

        if(!res.ok) { console.warn('Edge function error:', res.status); continue; }
        const data = await res.json();
        const text = (data.content?.[0]?.text || '').trim();
        if(!text) { console.warn('Empty response for', doc.name); continue; }

        // Extract JSON array from response
        const jsonMatch = text.match(/\[[\s\S]*\]/);
        if(!jsonMatch) { console.warn('No JSON array in response for', doc.name, ':', text.slice(0,100)); continue; }
        const parsed = JSON.parse(jsonMatch[0]);
        if(Array.isArray(parsed)) allRows.push(...parsed);

      } catch(e) {
        console.error('Error on', doc.name, e);
        // Continue to next image
      }
    }

    if(allRows.length > 0) {
      await saveParsedRows(allRows);
    } else {
      toast('No courses extracted â€” check images are transcript pages and try again');
    }
    setParsing(false);
  };

  // â”€â”€ Parse from pasted text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const parseFromPaste = async () => {
    if(!pasteText.trim()) { toast('Paste your transcript text first'); return; }
    if(!coachUrl) { toast('Coach URL not configured'); return; }
    setParsing(true);
    try {
      const res = await fetch(coachUrl, {
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+anonKey},
        body: JSON.stringify({messages:[{role:'user',content: PARSE_PROMPT + '\n\nTranscript text:\n' + pasteText}]})
      });
      const data = await res.json();
      const text = data.content?.[0]?.text || '';
      const cleaned = text.replace(/```json|```/g,'').trim();
      const parsed = JSON.parse(cleaned);
      await saveParsedRows(parsed);
      setPasteText('');
    } catch(e) {
      toast('Parse failed â€” check transcript format and try again');
    }
    setParsing(false);
  };

  const gpaColor = gpa===null?'var(--dim)':gpa>=3.7?'#059669':gpa>=3.3?'#d97706':'#dc2626';

  return (
    <div>
      <div className="page-header">
        <div className="page-title serif">GPA <em style={{color:'var(--gold)'}}>Tracker</em></div>
        <div className="page-sub">Cumulative GPA calculated from all courses Â· Updates coach and profile in real-time</div>
      </div>
      <div className="page-content">

        {/* 3-Panel GPA Hero */}
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'0.8rem',marginBottom:'1.5rem'}}>

          {/* Weighted */}
          <div className="card" style={{borderTop:'4px solid #7c3aed',textAlign:'center',padding:'1.2rem 0.8rem'}}>
            <div style={{fontSize:'0.65rem',fontFamily:'monospace',letterSpacing:'0.12em',textTransform:'uppercase',color:'#7c3aed',marginBottom:'0.4rem',fontWeight:700}}>Weighted GPA</div>
            <div style={{fontSize:'2.8rem',fontWeight:900,color:'#7c3aed',fontFamily:'serif',lineHeight:1}}>
              {gpaWeighted !== null ? gpaWeighted.toFixed(3) : 'â€”'}
            </div>
            <div style={{fontSize:'0.7rem',color:'var(--dim)',marginTop:'0.5rem',lineHeight:1.4}}>AP +1.0 Â· Honors +0.5<br/>Shows course rigor</div>
          </div>

          {/* Unweighted */}
          <div className="card" style={{borderTop:`4px solid ${gpaColor}`,textAlign:'center',padding:'1.2rem 0.8rem'}}>
            <div style={{fontSize:'0.65rem',fontFamily:'monospace',letterSpacing:'0.12em',textTransform:'uppercase',color:gpaColor,marginBottom:'0.4rem',fontWeight:700}}>Unweighted GPA</div>
            <div style={{fontSize:'2.8rem',fontWeight:900,color:gpaColor,fontFamily:'serif',lineHeight:1}}>
              {gpaUnweighted !== null ? gpaUnweighted.toFixed(3) : 'â€”'}
            </div>
            <div style={{fontSize:'0.7rem',color:'var(--dim)',marginTop:'0.5rem',lineHeight:1.4}}>Straight 4.0 scale<br/>Every class equal</div>
          </div>

          {/* Core Academic */}
          <div className="card" style={{borderTop:'4px solid #0369a1',textAlign:'center',padding:'1.2rem 0.8rem'}}>
            <div style={{fontSize:'0.65rem',fontFamily:'monospace',letterSpacing:'0.12em',textTransform:'uppercase',color:'#0369a1',marginBottom:'0.4rem',fontWeight:700}}>Core Academic GPA</div>
            <div style={{fontSize:'2.8rem',fontWeight:900,color:'#0369a1',fontFamily:'serif',lineHeight:1}}>
              {gpaCore !== null ? gpaCore.toFixed(3) : 'â€”'}
            </div>
            <div style={{fontSize:'0.7rem',color:'var(--dim)',marginTop:'0.5rem',lineHeight:1.4}}>EnglishÂ·MathÂ·Science<br/>Social StudiesÂ·Language</div>
          </div>
        </div>

        {/* Course count strip */}
        <div style={{textAlign:'center',marginBottom:'1.2rem',fontSize:'0.8rem',color:'var(--dim)'}}>
          {grades.filter(g=>g.grade_points!==null).length} graded courses Â·&nbsp;
          {grades.reduce((s,g)=>s+parseFloat(g.credit_hours||1),0)} total credit hours Â·&nbsp;
          {grades.filter(g=>g.is_ap).length} AP Â· {grades.filter(g=>g.is_honors).length} Honors
          {grades.length === 0 && ' Â· Add courses below to calculate'}
        </div>

        {/* Tabs */}
        <div style={{display:'flex',gap:'0.5rem',marginBottom:'1.2rem'}}>
          {[['view','ğŸ“Š View Courses'],['add','â• Add Course'],['parse','ğŸ“‹ Import Transcript']].map(([t,label])=>(
            <button key={t} onClick={()=>setTab(t)}
              className="btn btn-sm"
              style={{
                background:tab===t?'var(--ink)':'transparent',
                color:tab===t?'var(--cream)':'var(--dim)',
                border:'1px solid var(--border)',fontSize:'0.8rem'
              }}>{label}</button>
          ))}
        </div>

        {/* VIEW TAB */}
        {tab==='view' && (
          loading ? <div style={{color:'var(--dim)'}}>Loading...</div> :
          grades.length === 0 ? (
            <div className="info-box">No courses yet. Add them manually or import your transcript.</div>
          ) : (
            Object.entries(byTerm).sort().map(([semester, termGrades])=>(
              <div key={semester} style={{marginBottom:'1.5rem'}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.5rem'}}>
                  <div className="section-label">{semester}</div>
                  <div style={{fontSize:'0.8rem',fontFamily:'monospace',color:gpaColor,fontWeight:700}}>
                    Term GPA: {calcGPA(termGrades)?.toFixed(3)||'N/A'}
                  </div>
                </div>
                {termGrades.map(g=>(
                  <div key={g.id} className="card" style={{
                    display:'flex',alignItems:'center',justifyContent:'space-between',
                    padding:'0.7rem 1rem',marginBottom:'0.4rem',
                    borderLeft:`3px solid ${
                      g.grade_points>=3.7?'#059669':g.grade_points>=2.7?'#d97706':g.grade_points!==null?'#dc2626':'var(--border)'
                    }`
                  }}>
                    <div style={{flex:1}}>
                      <div style={{fontWeight:600,fontSize:'0.9rem'}}>
                        {g.course_name}
                        {g.is_ap && <span style={{marginLeft:'0.4rem',fontSize:'0.7rem',background:'#7c3aed',color:'#fff',padding:'1px 5px',borderRadius:'3px'}}>AP</span>}
                        {g.is_honors && <span style={{marginLeft:'0.3rem',fontSize:'0.7rem',background:'#0369a1',color:'#fff',padding:'1px 5px',borderRadius:'3px'}}>H</span>}
                      </div>
                      <div style={{fontSize:'0.78rem',color:'var(--dim)'}}>{g.credit_hours} cr Â· {g.source==='parsed'?'ğŸ“‹ imported':'âœï¸ manual'}</div>
                    </div>
                    <div style={{textAlign:'right',marginRight:'1rem'}}>
                      <div style={{fontSize:'1.3rem',fontWeight:700,color:
                        g.grade_points>=3.7?'#059669':g.grade_points>=2.7?'#d97706':g.grade_points!==null?'#dc2626':'var(--dim)'
                      }}>{g.grade_letter||'N/A'}</div>
                      <div style={{fontSize:'0.75rem',color:'var(--dim)'}}>{g.grade_points!==null?g.grade_points.toFixed(1):''}</div>
                    </div>
                    <button onClick={()=>deleteGrade(g.id)} className="btn btn-sm" style={{background:'transparent',color:'var(--dim)',border:'1px solid var(--border)',fontSize:'0.75rem'}}>âœ•</button>
                  </div>
                ))}
              </div>
            ))
          )
        )}

        {/* ADD TAB */}
        {tab==='add' && (
          <div className="card" style={{padding:'1.2rem'}}>
            <div style={{display:'grid',gap:'0.8rem'}}>
              <div>
                <label className="label">Course Name</label>
                <input className="input" value={form.course_name} onChange={e=>setForm(p=>({...p,course_name:e.target.value}))} placeholder="e.g. AP Psychology"/>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'0.6rem'}}>
                <div>
                  <label className="label">Grade</label>
                  <select className="input" value={form.grade_letter} onChange={e=>setForm(p=>({...p,grade_letter:e.target.value}))}>
                    {Object.keys(GRADE_POINTS).filter(k=>k!=='P'&&k!=='W'&&k!=='I').map(g=>(
                      <option key={g} value={g}>{g} ({GRADE_POINTS[g]?.toFixed(1)||'N/A'})</option>
                    ))}
                    <option value="P">P (Pass)</option>
                  </select>
                </div>
                <div>
                  <label className="label">Credits</label>
                  <input className="input" type="number" min="0.5" max="6" step="0.5" value={form.credit_hours} onChange={e=>setForm(p=>({...p,credit_hours:e.target.value}))}/>
                </div>
                <div>
                  <label className="label">Semester</label>
                  <select className="input" value={form.semester} onChange={e=>setForm(p=>({...p,semester:e.target.value}))}>
                    {SEMESTERS.map(s=><option key={s}>{s}</option>)}
                  </select>
                </div>
              </div>
              <div style={{display:'flex',gap:'1.5rem'}}>
                <label style={{display:'flex',alignItems:'center',gap:'0.4rem',cursor:'pointer',fontSize:'0.88rem'}}>
                  <input type="checkbox" checked={form.is_ap} onChange={e=>setForm(p=>({...p,is_ap:e.target.checked}))}/>
                  AP Course
                </label>
                <label style={{display:'flex',alignItems:'center',gap:'0.4rem',cursor:'pointer',fontSize:'0.88rem'}}>
                  <input type="checkbox" checked={form.is_honors} onChange={e=>setForm(p=>({...p,is_honors:e.target.checked}))}/>
                  Honors / CP
                </label>
              </div>
              <button className="btn btn-gold" onClick={addGrade} disabled={saving}>
                {saving ? 'Saving...' : 'â• Add Course'}
              </button>
            </div>
          </div>
        )}

        {/* PARSE TAB */}
        {tab==='parse' && (
          <div>
            {/* Mode toggle */}
            <div style={{display:'flex',gap:'0.5rem',marginBottom:'1rem'}}>
              <button onClick={()=>setParseMode('vault')} className="btn btn-sm"
                style={{background:parseMode==='vault'?'#059669':'transparent',color:parseMode==='vault'?'#fff':'var(--dim)',border:'1px solid var(--border)'}}>
                ğŸ“ From Document Vault {vaultDocs.length>0 && `(${vaultDocs.length} transcripts)`}
              </button>
              <button onClick={()=>setParseMode('paste')} className="btn btn-sm"
                style={{background:parseMode==='paste'?'var(--ink)':'transparent',color:parseMode==='paste'?'var(--cream)':'var(--dim)',border:'1px solid var(--border)'}}>
                ğŸ“‹ Paste Text
              </button>
            </div>

            {/* VAULT MODE */}
            {parseMode==='vault' && (
              <div>
                {vaultDocs.length === 0 ? (
                  <div className="info-box">
                    No transcripts found in your Document Vault. Upload your transcript images in the <strong>Document Vault</strong> under the "Transcript" category, then come back here.
                  </div>
                ) : (
                  <div>
                    <div className="info-box" style={{marginBottom:'1rem'}}>
                      <strong>ğŸ“ Select transcript pages from your vault</strong><br/>
                      The AI Coach will read each image and extract all courses, grades, and semesters automatically.
                    </div>
                    <div style={{display:'grid',gap:'0.5rem',marginBottom:'1rem'}}>
                      {vaultDocs.map(doc=>(
                        <label key={doc.id} style={{
                          display:'flex',alignItems:'center',gap:'0.8rem',
                          padding:'0.7rem 1rem',border:'1px solid var(--border)',
                          borderRadius:'6px',cursor:'pointer',
                          background: selectedDocs.includes(doc.id) ? '#f0fdf4' : 'var(--cream)',
                          borderColor: selectedDocs.includes(doc.id) ? '#059669' : 'var(--border)'
                        }}>
                          <input type="checkbox"
                            checked={selectedDocs.includes(doc.id)}
                            onChange={e=>{
                              if(e.target.checked) setSelectedDocs(p=>[...p,doc.id]);
                              else setSelectedDocs(p=>p.filter(id=>id!==doc.id));
                            }}
                          />
                          <span style={{fontSize:'1.2rem'}}>
                            {doc.name.match(/\.(png|jpg|jpeg)/i) ? 'ğŸ–¼ï¸' : 'ğŸ“„'}
                          </span>
                          <div style={{flex:1}}>
                            <div style={{fontWeight:600,fontSize:'0.88rem'}}>{doc.name}</div>
                            <div style={{fontSize:'0.75rem',color:'var(--dim)'}}>{doc.category}</div>
                          </div>
                          {selectedDocs.includes(doc.id) && <span style={{color:'#059669',fontWeight:700}}>âœ“</span>}
                        </label>
                      ))}
                    </div>
                    <div style={{display:'flex',gap:'0.5rem',marginBottom:'0.5rem'}}>
                      <button className="btn btn-sm" style={{fontSize:'0.75rem'}}
                        onClick={()=>setSelectedDocs(vaultDocs.map(d=>d.id))}>Select All</button>
                      <button className="btn btn-sm" style={{fontSize:'0.75rem'}}
                        onClick={()=>setSelectedDocs([])}>Clear</button>
                    </div>
                    <button className="btn btn-gold" style={{width:'100%',padding:'0.8rem',marginTop:'0.5rem'}}
                      onClick={parseFromVault} disabled={parsing||selectedDocs.length===0}>
                      {parsing
                        ? `ğŸ¤– Reading ${selectedDocs.length} image${selectedDocs.length>1?'s':''}...`
                        : `ğŸ¤– Read & Import ${selectedDocs.length} Selected Transcript${selectedDocs.length!==1?'s':''}`}
                    </button>
                  </div>
                )}
              </div>
            )}

            {/* PASTE MODE */}
            {parseMode==='paste' && (
              <div>
                <div className="info-box" style={{marginBottom:'1rem'}}>
                  Copy and paste transcript text below. The AI Coach extracts all courses, grades, credit hours, and semesters.
                </div>
                <textarea
                  className="input"
                  style={{minHeight:'200px',resize:'vertical',fontFamily:'monospace',fontSize:'0.82rem'}}
                  value={pasteText}
                  onChange={e=>setPasteText(e.target.value)}
                  placeholder="Paste transcript text here...&#10;&#10;Fall 2024&#10;AP Psychology  A  1.0&#10;AP Statistics  B+  1.0"
                />
                <button className="btn btn-gold" style={{marginTop:'0.8rem',width:'100%'}} onClick={parseFromPaste} disabled={parsing}>
                  {parsing ? 'ğŸ¤– Parsing...' : 'ğŸ¤– Import with AI Coach'}
                </button>
              </div>
            )}
          </div>
        )}

      </div>
    </div>
  );
}

function CoachModule({ user, coachUrl, toast }) {
  const [tab, setTab] = useState('chat');
  const [messages, setMessages] = useState([{role:'assistant',content:"Hi Sloan! I'm your Coach. I know your full profile, GPA, courses, activities, and everything in your Document Vault. Ask me anything â€” I can fill out application forms, help with essays, explain financial aid, quiz you on forensic psychology, or tell you what documents you still need. What do you need today?"}]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const [formText, setFormText] = useState('');
  const [formResult, setFormResult] = useState('');
  const [essayPrompt, setEssayPrompt] = useState('');
  const [essayDraft, setEssayDraft] = useState('');
  const [essayResult, setEssayResult] = useState('');
  const [essayLoading, setEssayLoading] = useState(false);
  const [formLoading, setFormLoading] = useState(false);
  const [essayType, setEssayType] = useState('Common App Personal Statement (650 words)');
  const bottomRef = useRef();

  useEffect(()=>{ bottomRef.current?.scrollIntoView({behavior:'smooth'}); },[messages,loading]);

  const getVaultContext = async () => {
    const sb = getSupabase();
    const [{ data:docs },{ data:achs }] = await Promise.all([
      sb.from('documents').select('name,category').eq('user_id',user.id),
      sb.from('achievements').select('title,role,impact').eq('user_id',user.id),
    ]);
    const docStr = docs?.length ? 'Uploaded documents: ' + docs.map(d=>`${d.name} (${d.category})`).join(', ') : 'No documents uploaded yet.';
    const achStr = achs?.length ? 'Achievements: ' + achs.map(a=>`${a.title} (${a.role})`).join(', ') : '';
    // Get live GPA from grades table
    const {data:gradeData} = await sb.from('grades').select('grade_points,credit_hours,course_name,semester').eq('user_id',user.id);
    const liveGpaUW     = calcGPA(gradeData||[]);
    const liveGpaW      = calcWeightedGPA(gradeData||[]);
    const liveGpaCore   = calcCoreGPA(gradeData||[]);
    const courseCount   = (gradeData||[]).length;
    const gpaStr = liveGpaUW !== null
      ? `Sloan's GPA (${courseCount} courses tracked): Weighted=${liveGpaW?.toFixed(3)||'N/A'} | Unweighted=${liveGpaUW.toFixed(3)} | Core Academic=${liveGpaCore?.toFixed(3)||'N/A'}. Use weighted GPA when discussing college competitiveness. Use unweighted when discussing transcript GPA. Core Academic is for UC-system and similar schools.`
      : "Sloan's GPA: approximately 3.84 (no courses entered in GPA Tracker yet â€” ask her to add them for precise calculations)";
    const courseList = gradeData && gradeData.length > 0
      ? 'Recent courses: ' + gradeData.slice(-5).map(g=>`${g.course_name} (${g.semester}: ${g.grade_letter||'N/A'})`).join(', ')
      : '';
    return gpaStr + '\n' + docStr + (achStr ? '\n' + achStr : '') + (courseList ? '\n' + courseList : '');
  };

  const callCoach = async (msgs) => {
    if(!coachUrl) { toast('Coach URL not set. Go to Settings and add your Edge Function URL.','warn'); return null; }
    const vaultContext = await getVaultContext();
    const res = await fetch(coachUrl, {
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+getAnonKey()},
      body: JSON.stringify({ messages: msgs.filter(m=>m.role!=='assistant'||msgs.indexOf(m)>0), vaultContext })
    });
    const data = await res.json();
    return data.content?.[0]?.text || 'No response.';
  };

  const sendChat = async () => {
    if(!input.trim()||loading) return;
    const userMsg = {role:'user',content:input.trim()};
    const newMsgs = [...messages, userMsg];
    setMessages(newMsgs);
    setInput('');
    setLoading(true);
    try {
      const reply = await callCoach(newMsgs);
      if(reply) setMessages(p=>[...p,{role:'assistant',content:reply}]);
    } catch(e) { toast('Coach error: '+e.message,'error'); }
    setLoading(false);
  };

  const analyzeForm = async () => {
    if(!formText.trim()) return;
    setFormLoading(true);
    try {
      const reply = await callCoach([{role:'user',content:`Analyze this college application form and generate answers for each field using Sloan's real information. Format as:\n[FIELD NAME]\nAnswer: [generated answer]\n\nForm:\n${formText}`}]);
      setFormResult(reply||'');
    } catch(e) { toast('Coach error','error'); }
    setFormLoading(false);
  };

  const getEssayHelp = async (mode) => {
    setEssayLoading(true);
    const prompt = mode==='outline'
      ? `Generate a structured essay outline for Sloan using her real background. Essay type: ${essayType}. Prompt: ${essayPrompt || '(general personal statement)'}`
      : `Review this essay draft and give specific, actionable feedback. Essay type: ${essayType}. Prompt: ${essayPrompt}.\n\nDraft:\n${essayDraft}`;
    try {
      const reply = await callCoach([{role:'user',content:prompt}]);
      setEssayResult(reply||'');
    } catch(e) { toast('Coach error','error'); }
    setEssayLoading(false);
  };

  const EDGE_FN_CODE = `import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
const ANTHROPIC_KEY = Deno.env.get('ANTHROPIC_API_KEY')
serve(async (req) => {
  const headers = { 'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'authorization, content-type',
    'Content-Type': 'application/json' }
  if (req.method === 'OPTIONS') return new Response('ok', { headers })
  const { messages, vaultContext } = await req.json()
  const systemPrompt = \`You are Sloan Smith's personal college application coach embedded in sloanmelia.com.
SLOAN'S PROFILE: Name: Sloan Smith | School: Alton High School, Alton IL | Graduating: May 2026 | GPA: 3.84 | Goal: PhD in Forensic Psychology
SENIOR YEAR: AP Psychology, AP Statistics, AP English (H), Human Body Systems PLTW 2, Biomedical Internship, Sociology, Spanish 2
KEY ACTIVITY: Patient Enrichment Program â€” FOUNDER. Annual hospital donation drive. This is her CENTERPIECE story.
Others: Mu Alpha Theta (Math Honor Society), Link Crew (Peer Mentor), Salvation Army volunteer, Church nursery, Math tutoring
VAULT: \${vaultContext}
Rules: Always use her real data. Format form fields as FIELD: answer. For essays, lead with Patient Enrichment Program.\`
  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: { 'x-api-key': ANTHROPIC_KEY, 'anthropic-version': '2023-06-01', 'content-type': 'application/json' },
    body: JSON.stringify({ model: 'claude-sonnet-4-6', max_tokens: 2048, system: systemPrompt, messages })
  })
  const data = await response.json()
  return new Response(JSON.stringify(data), { headers })
})`;

  return (
    <div>
      <div className="page-header">
        <div className="page-title serif">Your AI <em style={{color:'var(--gold)'}}>Coach</em> ğŸ¤–</div>
        <div className="page-sub">Powered by Claude Â· Knows your full profile and vault</div>
      </div>
      <div className="page-content">

        {!coachUrl && (
          <div style={{background:'#faf5e0',border:'2px solid var(--gold)',padding:'1.2rem',marginBottom:'1.5rem'}}>
            <div className="mono" style={{fontSize:'0.58rem',letterSpacing:'0.15em',textTransform:'uppercase',color:'var(--gold)',marginBottom:'0.5rem'}}>âš  Coach Setup Required</div>
            <p style={{fontSize:'0.88rem',lineHeight:1.65,marginBottom:'1rem'}}>The Coach needs a Supabase Edge Function to connect to Claude. Deploy the code below to Supabase, then reload this app and enter the function URL in setup.</p>
            <div style={{marginBottom:'0.5rem'}}>
              <div style={{fontFamily:'DM Mono,monospace',fontSize:'0.55rem',letterSpacing:'0.12em',textTransform:'uppercase',color:'var(--dim)',marginBottom:'0.3rem'}}>1. Run in your terminal:</div>
              <div className="copybox">supabase functions new coach<br/>supabase functions deploy coach<br/>supabase secrets set ANTHROPIC_API_KEY=sk-ant-YOUR-KEY</div>
            </div>
            <div>
              <div style={{fontFamily:'DM Mono,monospace',fontSize:'0.55rem',letterSpacing:'0.12em',textTransform:'uppercase',color:'var(--dim)',marginBottom:'0.3rem'}}>2. Replace the function code with this:</div>
              <div className="copybox" style={{maxHeight:'200px',overflow:'auto'}}>{EDGE_FN_CODE}</div>
            </div>
            <button className="btn btn-gold btn-sm mt2" onClick={()=>{navigator.clipboard.writeText(EDGE_FN_CODE);toast('Code copied!','success');}}>Copy Edge Function Code</button>
          </div>
        )}

        <div className="tabs">
          {[['chat','ğŸ’¬ Chat'],['form','ğŸ“‹ Form Filler'],['essay','âœï¸ Essay Coach']].map(([id,label])=>(
            <div key={id} className={`tab${tab===id?' active':''}`} onClick={()=>setTab(id)}>{label}</div>
          ))}
        </div>

        {tab==='chat' && (
          <div className="chat-area">
            <div className="chat-messages">
              {messages.map((m,i)=>(
                <div key={i} className={`chat-bubble ${m.role==='user'?'user':'coach'}`}>
                  {m.content.split('\n').map((line,j)=><div key={j}>{line||'\u00a0'}</div>)}
                </div>
              ))}
              {loading && <div className="typing chat-bubble coach"><span/><span/><span/></div>}
              <div ref={bottomRef}/>
            </div>
            <div className="chat-input-row">
              <input className="chat-input" value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&sendChat()} placeholder="Ask your Coach anything..." disabled={loading}/>
              <button className="btn btn-gold" onClick={sendChat} disabled={loading||!input.trim()}>Send</button>
              <button className="btn btn-ghost" onClick={()=>setMessages([messages[0]])}>Clear</button>
            </div>
            <div style={{marginTop:'0.5rem',display:'flex',gap:'0.5rem',flexWrap:'wrap'}}>
              {['Fill my Common App activities section','What documents am I missing?','Help me write my personal statement','Explain FAFSA to me simply'].map(s=>(
                <span key={s} style={{fontSize:'0.72rem',padding:'0.25rem 0.7rem',border:'1px solid var(--faint)',cursor:'pointer',color:'var(--dim)'}} onClick={()=>{setInput(s);}}>{s}</span>
              ))}
            </div>
          </div>
        )}

        {tab==='form' && (
          <div>
            <div style={{background:'#fff8e8',border:'1px solid var(--gold)',padding:'0.8rem 1rem',marginBottom:'1rem',fontSize:'0.82rem'}}>
              âš  Review all answers before pasting. Always verify school-specific requirements and current dates.
            </div>
            <label className="label">Paste any college application form, FAFSA section, or scholarship question here</label>
            <textarea className="input mb2" style={{minHeight:180}} value={formText} onChange={e=>setFormText(e.target.value)} placeholder="Paste the form fields or questions here...&#10;&#10;Example:&#10;Student Name:&#10;High School:&#10;GPA:&#10;List your extracurricular activities..."/>
            <button className="btn btn-gold" onClick={analyzeForm} disabled={formLoading||!formText.trim()}>{formLoading?'Analyzing...':'ğŸ¤– Analyze & Fill Form'}</button>

            {formResult && (
              <div style={{marginTop:'1.5rem'}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.5rem'}}>
                  <div className="section-label" style={{margin:0}}>Coach-Generated Answers</div>
                  <button className="btn btn-outline btn-sm" onClick={()=>{navigator.clipboard.writeText(formResult);toast('Copied!','success');}}>Copy All</button>
                </div>
                <div style={{background:'var(--white)',border:'1px solid var(--faint)',padding:'1.2rem',whiteSpace:'pre-wrap',fontFamily:'DM Mono,monospace',fontSize:'0.78rem',lineHeight:1.8}}>{formResult}</div>
              </div>
            )}
          </div>
        )}

        {tab==='essay' && (
          <div>
            <div className="mb2">
              <label className="label">Essay Type</label>
              <select className="select" value={essayType} onChange={e=>setEssayType(e.target.value)}>
                {['Common App Personal Statement (650 words)','Why This School Essay (250-650 words)','Scholarship Essay (varies)','Extracurricular Activity Description (150 chars)','Short Answer (100-250 words)'].map(t=><option key={t}>{t}</option>)}
              </select>
            </div>
            <div className="mb2">
              <label className="label">Essay Prompt (paste it here)</label>
              <textarea className="input" style={{minHeight:80}} value={essayPrompt} onChange={e=>setEssayPrompt(e.target.value)} placeholder="Paste the essay prompt or question here..."/>
            </div>
            <div className="mb2">
              <label className="label">Your Draft (optional â€” paste for feedback)</label>
              <textarea className="input" style={{minHeight:120}} value={essayDraft} onChange={e=>setEssayDraft(e.target.value)} placeholder="Paste your draft here to get specific feedback..."/>
            </div>
            <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap'}}>
              <button className="btn btn-gold" onClick={()=>getEssayHelp('outline')} disabled={essayLoading}>Get Outline</button>
              <button className="btn btn-primary" onClick={()=>getEssayHelp('review')} disabled={essayLoading||!essayDraft.trim()}>Review My Draft</button>
            </div>
            {essayLoading && <div className="mt2 mono" style={{fontSize:'0.65rem',color:'var(--gold)',letterSpacing:'0.1em'}}>Coach is thinking...</div>}
            {essayResult && (
              <div style={{marginTop:'1.5rem'}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.5rem'}}>
                  <div className="section-label" style={{margin:0}}>Coach Response</div>
                  <button className="btn btn-outline btn-sm" onClick={()=>{navigator.clipboard.writeText(essayResult);toast('Copied!','success');}}>Copy</button>
                </div>
                <div style={{background:'var(--white)',border:'1px solid var(--faint)',padding:'1.2rem',whiteSpace:'pre-wrap',fontSize:'0.88rem',lineHeight:1.75}}>{essayResult}</div>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
}

// â”€â”€ ROOT APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const { toasts, toast } = useToast();
  const [config, setConfig] = useState(null);
  const [user, setUser] = useState(null);
  const [page, setPage] = useState('home');
  const [authLoading, setAuthLoading] = useState(true);

  useEffect(()=>{
    const url = localStorage.getItem('sm_url');
    const key = localStorage.getItem('sm_key');
    const coach = localStorage.getItem('sm_coach')||'';
    if(url&&key) {
      initSupabase(url,key);
      setConfig({url,key,coachUrl:coach});
      const sb = getSupabase();
      sb.auth.getSession().then(({data:{session}})=>{
        if(session?.user) setUser(session.user);
        setAuthLoading(false);
      }).catch(()=>setAuthLoading(false));
      sb.auth.onAuthStateChange((_,session)=>{
        setUser(session?.user||null);
      });
    } else setAuthLoading(false);
  },[]);

  const handleSetup = (cfg) => {
    setConfig(cfg);
    const sb = getSupabase();
    sb.auth.getSession().then(({data:{session}})=>{ if(session?.user) setUser(session.user); setAuthLoading(false); });
  };

  const signOut = async () => {
    await getSupabase().auth.signOut();
    setUser(null);
  };

  if(!config) return (<><ToastContainer toasts={toasts}/><SetupScreen onSetup={handleSetup}/></>);
  if(authLoading) return <div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center'}}><div className="typing"><span/><span/><span/></div></div>;
  if(!user) return (<><ToastContainer toasts={toasts}/><LoginScreen onLogin={setUser} toast={toast}/></>);

  const moduleProps = { user, toast, coachUrl: config.coachUrl };

  return (
    <div style={{display:'flex'}}>
      <ToastContainer toasts={toasts}/>
      <Sidebar page={page} onNav={setPage} user={user} onSignOut={signOut}/>
      <div className="main-area" style={{flex:1}}>
        {page==='home'         && <HomeModule {...moduleProps} onNav={setPage}/>}
        {page==='library'      && <LibraryModule {...moduleProps} onNav={setPage}/>}
        {page==='vault'        && <VaultModule {...moduleProps}/>}
        {page==='tracker'      && <TrackerModule {...moduleProps}/>}
        {page==='achievements' && <AchievementsModule {...moduleProps}/>}
        {page==='financial'    && <FinancialModule {...moduleProps}/>}
        {page==='gpa'          && <GpaModule user={user} toast={toast}/>}
        {page==='profile'      && <ProfileModule user={user} toast={toast}/>}
        {page==='coach'        && <CoachModule {...moduleProps}/>}
      </div>
    </div>
  );
}

class ErrorBoundary extends React.Component {
  constructor(p){super(p);this.state={err:null};}
  static getDerivedStateFromError(e){return{err:e};}
  render(){
    if(this.state.err) return (
      <div style={{fontFamily:'monospace',padding:'2rem',color:'#9a1a1a',background:'#faf7f2',minHeight:'100vh'}}>
        <h2>SloanMelia Error</h2>
        <p><strong>{this.state.err.message}</strong></p>
        <pre style={{fontSize:'0.75rem',whiteSpace:'pre-wrap'}}>{this.state.err.stack}</pre>
        <button onClick={()=>this.setState({err:null})} style={{marginTop:'1rem',padding:'0.5rem 1rem',cursor:'pointer'}}>Retry</button>
      </div>
    );
    return this.props.children;
  }
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<ErrorBoundary><App/></ErrorBoundary>);
</script>
</body>
</html>
